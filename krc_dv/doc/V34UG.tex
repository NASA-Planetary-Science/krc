
\documentclass{article} 
\usepackage{underscore} % accepts  _ in text mode
\usepackage{ifpdf} % detects if processing is by pdflatex
\usepackage{/home/hkieffer/xtex/newcom}  % Hughs conventions
% \newcommand{\qj}{\\ \hspace*{-2.em}}      % outdent 1

\textheight=10.00in \topmargin=-1.1in % bot need 0.1 more        %OK
\textwidth=7.50in  \oddsidemargin=-0.4in \evensidemargin=-0.4in  %OK

% 1 of next 2 used in place of  \qen for development to identify equation labels 
\newcommand{\ql}[1]{\label{eq:#1} \hspace{1cm} \mathrm{eq:#1} \end{equation}}
%\newcommand{\ql}[1]{\label{eq:#1} \end{equation} } % for final

\title{Guide to KRC version 3.4, and background }
\author{Hugh H. Kieffer  \ \ File=-/krc/Doc/DV3/V34UG.tex  2017feb23,Oct18}
\begin{document} %==========================================================
\maketitle
\tableofcontents
\listoffigures
%\listoftables
\hrulefill .\hrulefill
% \pagebreak 

\section{Preamble}
This accompanies release of KRC version 3.4.4 . ASU last formal
release is version 2.4.1; prior latest version in the ASU repository is 3.2.1 .

The prior version 3.3 has been abandoned; that alpha release should be ignored.

This document includes both a Users Guide and a detailed description of the development.

Sections \ref{UG} to \ref{invis} are a Users Guide to changes since the prior formal release.
\\ \textbf{ The Users Guide ends with  \S \ref{zform}; most users should not need to read beyond that,} where the tone of this document becomes closer to lab notes.  

Sections \ref{devd} to \ref{issu} have some development details.
 
Sections \ref{t1} to \ref{t2} cover testing.

Sections \ref{plans} discusses briefly plans for additional capabilities

The appendix includes a short discussion of tuning KRC for efficiency. 

One intention of including the far-flat and photometric function capabilities was
to address asteroid models, including ``thermal beaming'' . This can be done by
running a large grid of sloped models and post-processing the output files; see
\nf{Beaming.tex}
 

\subsection{Distribution files}
 Organization into directories is the same as other recent KRC distributions. 
Files in the V3.4.4 distribution include: 
\qi All source code and a Makefile
\qi Revised helplist
\qi Updated KRC evolution and flow diagrams
\qi Several example input files for V3.4
\qii Some annotated sample zone tables.
\qii One lengthy file for generating a grid of slopes 
\qi Print file and binary .t52 file generated by input files
\\ Documentation  \ \ See -/doc/*.pdf
\qi helplist.pdf:   Basic description of method, input parameters and output.
\qi Kieffer13krc.pdf: JGR article as published.
\qi krcV3.pdf:  JGR article with corrections.    
\qi V34UG.pdf: This document, and its source files: \nf{V34UG.tex, farg.tex, fard.tex, v34p.tex}.
\qi PUG.pdf and hporb.pdf: Use of the Planetary orbit system.
\qi thin.pdf: Thin layers and performance of KRC.
\qi - - -  Specialize documents
\qi Ash.pdf:  2016 January comparison of KRC and Ashwin Vasavada thermal models for Mars.
\qi simple.pdf:  2016 Feb. study of convergence and performance of KRC versus a simple, but slow, thermal model.
\qi HeatOfT.pdf: Literature search on temperature-dependence of thermal properties.
\qi cement.pdf: Effect of inter-grain cementing.
\qi mkrc.pdf:  Making global movies with KRC.
\qi Vtest.pdf: Testing between different KRC versions


\section{Introduction \label{UG}}

This includes a users guide for version 3.4.4 of KRC. It covers primarily ONLY THE CHANGES from version 2.4.1, which are:
\qi May have a condensing gas other than CO$_2$. \S \ref{gas} 
 \qi May invoke some Surface Photometric Models when there is no atmosphere. \S \ref{pm}
 \qi May specify Tables of material properties versus depth. \S \ref{zone}
 \qi May include Geothermal heat flow. \S \ref{ghf} 
\qi Optional user-specified ``unique'' output; two specific sets are coded thus far. \S \ref{tun}
\qi Can now write type 52 and a direct-access file at the same time
\qi For sloped surfaces, the far-field solar and thermal radiance can be from a flat surface or the traditional``self-heating''.

Some new default values are: 
\qi TAURAT=0.25: closer to modern estimates of dust properties.
\qi RLAY=1.12, FLAY=0.1, N2=1536, CONVG=3.
\qii these improve the numerical accuracy at a modest cost in speed
\qi N24=48: binary output every 1/2 hour, rather than once per hour.

With the incorporation of zone tables, the two materials specified in the
'ConUp0 ...' and 'SphUp0 ...' lines are no longer necessarily the ``upper'' and
``lower'' materials; they are here referred to as material A (normally Above,
was 'upper') and material B (normally Below, was 'lower')

\subsection{Notation use here}
The following fonts styles have been partially implemented: 
\qi File names are shown as \nf{filename}. 
\qi Program and routine names are shown as \np{PROGRM [,N]} , or simple UPPERCASE
\qii where \np{N} indicates a major control index.
\qii The last character''8'', representing the double precision (8-byte) version, is often omitted. 
\qi Code variable names are shown as \nv{variab} or  \nv{VARIAB} and within equations as $\nvf{variab}$.  
\qi Input parameters are shown as \nj{INPUT} and within equations as $\njf{INPUT}$


\subsection{New routines}
FORTRAN routines:
\\ TFAR \ Open and read KRC type -n direct-access file
\\ CUBUTERP \ Cubic interpolation of uniformly spaced points to higher density
\\  TDISK \ Revised extensively to store/write type 52 and type -n files simultaneously 
\\ FILLMV a set of 12 routines to fill an array or any contiguous part thereof
with a constant or MoVe (copy) a part of one array to another. Arrays are
dimensioned with the size of the move, so the compiler can check
out-of-bounds. Individual routines FILLx and MVx for each data type where x is:
B=byte, I=integer*2, L=integer*4, R=real*4, D=real*8.  Also:
\qi MVDF multiplies each value by a constant factor
\qi MVDA multiplies each value by a constant factor and adds it to the current destination
\qii these last two are handy for linear interpolation, such as in season.

IDL routines:
\\ KRCLAYER \ Compute and print KRC layer depth table from KRCCOM values
\\  NUMGEOMLAY \ Compute number of geometrically thick layers for total depth
\\  FLAYER \ Replicate Fortran KRC TDAY statement function
\\  KV3 \ Check consistency of KRC within and between versions
\qii this has grown almost unmanageable, 2650 lines
\qiii @535 can generate zone table for lunar-like compaction profiles.
\\ HEMIALB Evaluate various photometric functions, especially for hemispheric albedo

\section {User changes needed even if none of the new capabilities are used \label{need}}
\begin{enumerate}    % numbered items 


\item  KRC now adds the extension ".inp" to the name you give it for
  the input file and adds ".prt" to the print file.
  The leading part of the print file defaults to the same as the input file.

\item Specification of the saturation point. Real parameters 11 and 32 were
  unused; they now specify the saturation temperature relation for the
  condensing gas. Values for CO$_2$ are  27.9546 and 3182.48 . These values are in
  the latest KRC master input file.

\item The 22'nd real parameter, ARC3, was unused. It is now the minimum
  allowable numerical convergence factor, which in theory is 1. The default
  value is 0.801 as KRC has been found to be generally stable to this level. If
  you have any hint of instability, set this to 1.0 (and let me know).

 \item The 7'th integer parameter IIB (was IB). This controls the lower boundary
   condition. Positive values are heat-flow, see \S \ref{ghf}. The flag values
   are now the negative of the earlier meanings. e.g.:
\qi  0 = insulating (as before)
\qi -1 = constant temperature 
\qi -2 = start all layers =TDEEP and keep boundary at a constant temperature 

\item The 14'th logical value, LZONE, is now a flag for use of a zone table. It
  should initially be 'F'; it will be set/reset automatically by specification
  of a zone table file name.

\item File designations: see \S \ref{filed} for more details. Helplist \S 4 for complete list.
\qi Type 52 write: 8 5 0 'filename.t52' \ Specifies the type 52 file, regardless of K4OUT.  Applies until canceled by: 8 5 0 'off'
\qi  Write direct-access: 8 21 0 '<filename>' \ Set K4OUT to -1, -2, or -3
\qii Applies only to current case. 
\qi Read a far-field file:  8  3 0 '<filename>' \ Applies until canceled by: 8 3 0 'off'

\end{enumerate}

\subsection{ALERT: Layer depths may vary with albedo or emissivity}

In V342+, if Temperature-dependent properties are invoked, the scaling to layer
thicknesses in meters is done using the diffusivity computed from the input
parameter DENS and the specific heat and conductivity computed for the global
equilibrium temperature, unless zones defined the layers.  I.e., if LKOFT is
True and there is not a zone table, the layer thicknesses in meters will depend
upon Albedo. In V321 and earlier, the scaling is always based on the input
parameters DENS, SPHT and conductivity derived from INERTIA; and corresponding
parameters for the lower material if used.

\subsection{OnePoint mode}
All the new capabilities have not been thoroughly tested in onePoint mode. The
master onePoint file \nf{Mone.inp} works. The geothermal-flow, non-CO$_2$ gas
and photometric functions are expected to be compatible with onePoint mode, but
use of optional files for zone tables or far-field temperatures is questionable
and has not been tested; see the notes in \S \ref{fffd}

\section{Any condensible gas \label{gas}}

The coefficients for the saturation temperature relation for the condensing gas
are now input parameters. KRC uses the Clausius-Clapeyron relation $\ln P = a -
b/T$ where $P$ is pressure in Pascal and $T$ is temperature in Kelvin. This
should be useful for Titan, Pluto, ...

Real parameter 11, ABRPHA, was unused; it is now SatPrA, the Clausius-Clapeyron
coefficient 'a'. Real parameter 32, fd32, was unused; it is now SatPrB, the
Clausius-Clapeyron coefficient 'b' .  Values for CO$_2$ are a=27.9546 and
b=3182.48 .

The proper molecular weight should be input as real parameter 10, AMW. The
Mass-fraction of mean atmosphere that is non-condensing, real parameter 13,
FANON, should also be specified.

\section{Surface Photometric Models \label{pm} }
This is only active if there is not an atmosphere; the Delta-Eddington model
used to handle atmospheric opacity includes the assumption that the surface is
Lambertian. In some later version when more input parameters are available, it
is intended to be allowed when there is an atmosphere

The 21'th real parameter, ARC2, otherwise meaningless when no atmosphere, is defined as follows:
\qi 0 = Lambertian: $\frac{I}{\pi F} = A \cos i$ 
\qi $\leq -1$  = Lommel-Seeliger: $\frac{I}{\pi F} =A \cos i /(\cos i+ \cos e) $
\qiii This is the result for isotropic single scattering.
\qi  $-1< x< 0$ = Minnaert exponent, k=-x: $\frac{I}{\pi F}= A \mu_0^k \mu^{(k-1)}, \ \mu \equiv \cos e, \  \mu_0 \equiv \cos i $
\qiii $k=1$ is same as Lambert
\qi $ 0<x $ = Lunar-like. : $A_h= A \left( 1.+ x (\theta/45)^3+1.17(\theta/90)^8 \right)$
\qiii x= +0.25 [and A=0.12] is \qcite{Keihm84} \ \ \ x=0.375 is  \qcite{Vasavada12}

With incorporation of non-Lambertian albedos; must be thorough in defining just
what is meant by the ``albedo'' input parameter in KRC.  As of version 3.4.1, it
is the hemispheric albedo (solar weighted) for incidence angle of zero; which
simplifies comparisons between KRC runs but places a burden of scaling on the
user of non-Lambertian photometric functions. The  KRC equilibrium temperature
(normal incidence, zero thermal inertia) is thus not affected by the
photometric function.

[Another option might be to normalized to the apparent brightness at some
  standard non-opposition geometry, such as $i=0^\circ,  e=30^\circ$ ]
 
The bolometric hemispherical albedo is computed as a function of incidence
angle.  See \S \ref{Ah} for details.

Curves for various hemispherical albedos are shown in Figure 
\ref{hem46n}  
\begin{figure}[!ht] \igq{hem46n}
\caption[Various hemispherical albedos]{Dependence of hemispherical albedo on
  incidence angles for various models, indicated in legend. All have been
  normalized to unity at normal incidence.
\label{hem46n}  hem46n.png }
\end{figure} 
% how made: 

Development details are in \S \ref{photo}.  

\section{Tables of material properties \label{zone}}
A zone file name is defined by a change card: 8 25 x 'fileName' / where the 3rd column (x) is
ignored. The zone file may have up to 20 lines of comments before a ``C_END''
line. Thereafter each row defines a zone and must contain 4 columns (additional
columns are allowed but not read):
\qi Col 1: thickness, m
\qi Col 2: density, kg/m$^3$ \hspace{1.0 cm} However
\qiii -1 = use DENS [real parameter 8] the material A density
\qiii -2 = use DENS2 [real parameter 5] the material B density
\qi Col 3: Conductivity, SI Units. \ $\lceil$   If negative then col 4 is a pointer
\qi Col 4: Specific heat, SI Units \ \  $\lfloor$  1=material A , 2=material B 
\\ There must be at least 3 zones [otherwise the two materials within the current input parameters would be adequate]
\\ The thickness of the last zone is ignored; KRC will fill out to the number of geometric layers specified by N1 [integer parameter 1] 
\\ A line with column 1 non-positive will stop reading. E.g., `` 0 0 0 0 '' . This may be followed by any number of comment lines.

KRC will be expand the zones into an appropriate number of layers to approximate
the RLAY and FLAY relation [real parameters 32 and 33]. If the table contains
zones that are near the implied geometric progression; that exact thickness
value will be used.  If a zone definition violates the convergence stability
requirements or the number of layers specified by N1, the case will be skipped
with a warning.

If the second debug parameter (optional 2nd line of input file) is set to 3, a detailed list of layer generation will be printed. 

To cancel a zone table, specify a file path-name containing a single character.

Development details are in \S \ref{devd}.

\section{Geothermal heat flow \label{ghf}}

The 7'th integer parameter IIB (was IB): positive values are the geothermal heat
flow in milli-Watts/m$^2$. Zero and negative integers set other lower-boundary
conditions ( see \S \ref{need})  

Development details are in \S \ref{hfd}.

\section{Multiple output files}
KRC can now write type 52 files and one of the direct-access file types at the same time. Either or both can be changed before any case.

A type 52 file is initiated by defining its name: 
\vspace{-3.mm} 
\begin{verbatim}
8  5 0 '<file>.t52' / Initiate multi-case output file of temperatures and other values 
\end{verbatim} 

A type 52 file can be terminated by setting the file path-name to less than 4
characters; e.g., 'off'. A direct-access file opened for write is automatically
closed after one case.

\subsection{File designations change from earlier versions \label{filed}}

The second number for change card type 8 has changed. This is
   described in the latest version of helplist, section 4. E.g.,
   8 5 0 'filename.t52' / specifies the type 52 file, regardless of K4OUT.
   The prior K4OUT=-1  would now be K4OUT =-2 to get  Tsurf and Tplan.
   And the type -n output file name is specifed by change line: e.g.,
   8 21 0 'filename.tm2' / type -2 output file

Specifically:
A)  To write a type 52 file, you must have a change line
\qi  8 5 0 '<filename>'
 \qi The value of the third field (0) is ignored but some number must be there
    The value of K4OUT is ignored

B) To write a direct-access file, as used for THEMIS production runs or to save a far-field
\qi set K4OUT to -1, or -2, or -3 to save Tsurf, or that and Tplan, or those and Tatm.
\qi Use a change line \hspace{1cm}      8 21 0 '<filename>'
\qi  Direct-access files can only hold one case, and are closed automatically after the last season.

C) For either kind of file, putting a change line with a new <filename>  will close an open file.
\qi     A new file will be started only if <filename> has 4 or more characters.
 \qi  Thus,  <filename> less than 4 characters can be used to turn output off.

D)  To read a far-field file, use a change line \hspace{1cm}  8  3 0 '<filename>'
\qi    K4OUT is ignored, as the number of temperature types contained is specified in the far-file.
\qi   This will stay in effect until the closed by a short name; e.g. \hspace{1cm}      8 3 0 'off'


\section{Far-field for sloped surfaces} 

\input{farg} %<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<

\section{Special output \label{tun}}
The ``unique'' routine TUN8 is designed to address potential special requests
for data output. It writes lines of text to 'fort.77', which must be renamed
after a run to avoid being overwritten. There are currently two uses coded into
the KRC system; more can be added. 

TUN8 has two required arguments:
\qi Arg. 1 (integer) is a code that determines what to print  
\qii existing: 101 writes temperatures for each layer.
\qii existing: 102 writes a number of radiation items. 
\qi Arg. 2 (integer) is a stage:
\qii 1 writes case count and expected sizes 
\qii Else: writes a line of data
\qi Two additional arguments are available to the user.
\qii Arg. 3, Integer
\qii Arg. 4, Real*8

Sections of code within TUN8 could write anything that is in the COMMONs.

Activity is controlled by integer parameter 15, I15. To avoid conflict/confusion 
with older uses of this parameter, only values greater than 100 activate TUN8.

Existing calls to TUN8:
\\ For any value I15 of 100 or more: KRC will call: TUN8 (I15,1) for each case. Existing code:
\\ 101: TDAY will write call TUN8(I15,2,IH,(ignored)) at each output 'hour' on last day of every season of JDISK or more 
\\ 102: TLATS will call TUN8(I15,2,I,SOLDIF) after TDAY done for every latitude for every season of JDISK or more.    

\section{Invisible changes \label{invis}} 
\begin{itemize}      % ticked items 

 \item Layer stability when using T-dependent materials: need stability from
   midday equator to winter poles. For low-obliquity or airless bodies this
   could be large range in temperature.

Because KRC design has the same layer structure for all latitude and seasons, a
practical compromise is to use the global equilibrium temperature: $ S_o
(1-A)/(2 \pi U^2)= \epsilon \sigma T_g^4$ .

Layer thickness prior to V3.3 was based on the T-constant properties even if
using T-dependent materials.  V 3.4 uses the appropriate materials for each
layer at $T_g$

Note: Basing layer on $T_g$ properties means that layering will change with ALB
and EMISS for T-dependent materials.

Layer table generation was moved into TDAY to accomplish this even with
intermixed T-con and T-dep materials from zone tables.

\item  A third value of the TDAY input argument is used to print a layer table.

\item  The logic for page-header lines in the print file changed slightly.

\end{itemize}

\section{Zone table Details \label{devd}} %--------------
\subsubsection{Format \label{zform}}
Zone table format: 
\\ Up to 19 lines of comments are permitted before a required lines starting exactly as ``C_END''
\\ Zones specified from surface down. Columns white separated.
\\ Each line specifies a zone of uniform material properties.
\qi Col 1: zone thickness, m. \  Value for last row ignored; KRC fills out layers
\qi Col 2: density, kg/m$^3$.   \  -1=A material DENS,   -2=B material DENS2
\qi Col 3: Conductivity, SI Units. $\lceil$ \ If negative, then col 4 is a pointer
\qi Col 4: Specific heat, SI Units. $|$ \ 1,2=Tcon: 1=A material, 2=B material
 \\. \hspace{4.cm} $\lfloor$ \ 3,4=Tdep: 3=A material, 4=B material
\\ 3 or more valid lines are required. Comments may follow the 4 numeric columns
\\ The thickness in the last valid line is ignored. KRC will fill out layers up to N1. 
\\ A non-positive first column (of 4 numeric columns) stops the input; Required.
\qi Any number of zone lines or comments may follow the stop line

KRC will convert a zone to multiple layers as allowed by stable convergence.

Numerical stability: $ (\Delta t / (\Delta Z)^2) \kappa < 1/2  \mc{or} C_s \equiv B / \sqrt{2  \kappa \Delta t}$
\qii If definition of a zone has convergence safety factor $C_s <$ ARC3, KRC will print a layer table and quit that case.
\qii $C_s$ is an estimate of how many layers could be used in this zone.

\subsubsection{Modifications to TDAY: Logic flow }
The potential to have more than two types of material required a major change in the organization of TDAY. 

\vspace{2.mm}
\large  V3.4 logic flow for the TDAY \textbf{setup} call: \normalsize
\\ - Compute global equilibrium temperature $T_g$.
\\ - Compute properties of T-dep materials at $T_g$.
\\ - Calculate a table of the sum of normalize layer thicknesses using RLAY and FLAY.
\\ - If zone table active, LZONE true, read a zone table.
\\ - If LZONE is true, process the zone table from top to bottom, expanding each
zone into the number of layers which is the closest fit to maintaining the RLAY
sequence. Generate layer-arrays for conductivity $k$, density $\rho$, and
specific heat $C_P$.  Write each layer to the print file. Generate the virtual
layer using the properties of the first physical layer.
\qi - If number of layers exceeds N1, print message
\\ - If LZONE is false, generate the same 3 layer-arrays as above.
\\ - Set a logical flag LALCON true if and only if all layers are T-con.
\\ - If LALCON false, compute first and number of layers in the T-dep zones.
\\ - If LALCON false, print a table of T-dep material properties versus temperature.
\\ - If using 2 materials, check the convergence factor of the top layer of the lower material; increase its thickness if required for stability.
\\ - Compute the center depth and the convergence safety factor for each layer.
\\ - Compute the minimum safety factor at each layer for itself and all lower layers.
\qi - If minimum factor less than allowed, Set return flag to skip this case and print message.
\\ - Compute time-doubling allowed and the resulting factors: $F_{1_i}, \ F_{2_i}, \ F_{3_i}, \ F_{B_i}, \ F_{C_i}$. See \S 3.2 of \qcite{Kieffer12}
\\ - Build the doubling-depth comb.
\\ - If using geothermal heat-flow, set the flag LGHF true and compute the lower-boundary temperature offset.
\\ - Print the layer table.

\vspace{2.mm}
\large V3.4 logic flow for the TDAY \textbf{season} call: \normalsize
\\ - Compute constant factors; set atmosphere and frost flags.
\\ - Loop on days
\qi - Loop on time-steps
\qii - Set the lower boundary condition
\qii - Loop on layers
\qiii - If LALCON true, $\Delta T_i$ for all layers in the comb  
\qiii - If LALCON false, compute $k_i$ and $C_{Pi}$ for any layers in the first and second T-dep zones. 
\qiiii Then compute  $F_{1_i}, \ F_{3_i}$ and $\Delta T_i$ for all layers in the comb   
\qii - Apply  $\Delta T_i$ to all layers in the comb 
\qii - Satisfy the upper boundary condition. Adjust atmosphere temperature and frost amounts as needed.
\qii - If on an output hour, save values.
\qi - Check if next day could be the last of the season
\\ - If this is the last day; save values and return


\vspace{2.mm}
\large  Detailed printouts: \normalsize
 \\ to monitor: 
\qi As zones are read: e.g.,  K,IH,LALCON=           1           0 T
\qii K is zone (row in table) count
\qii IH is code set by column 3. 0 means was an actual conductivity
\qiii + 1,2,3,4 are codes for A/B material and Tcon/Tdep
\qii LALCON is current value of ``all layers thus far are Tcon''
\qi As layers are created: e.g.,  Zone,I,II,ZBOT,DBOT= 22  1  2     0.79880    35.60257
\qii Zone is zone (row in table) count
\qii I is is count of new layers within one zone
\qii II is upper index of layers planned in this zone
\qii ZBOT is depth in meters of the bottom of PRIOR layer
\qii DBOT is depth in diurnal scale of the bottom of PRIOR layer
 \\ to print file:
 \vspace{-3.mm} 
\begin{verbatim}   
 Zon I Lay   D___bottom___m thick_m Conductiv Density SphHeat  Diffusive  Inertia
  1  1  2    0.134   0.0029  0.0029 0.1004E-01 1002.8  600.00 0.1669E-07    77.72
Zon: is 1-based index of zone in file
  I: is 1-based layer count within a zone
Lay: is KRC layer index
\end{verbatim} .
\qi J,BLAY,SCONVG,QA   2 0.29042E-02 0.52716E-10     1.0
\qii J is KRC layer 
\qii BLAY is  layer thickness in m
\qii SCONVG is convergence safety factor before any time-doubling
\qii QA is the time doubling factor for that layer
  
If Layer depths are increasing too rapidly, must decrease FLAY by appropriate factor.

\subsubsection{Generated layer thickness}
As layer are generated from zones, maintain cumulative depth in local-scale
units. For each new zone, determine the ideal first-layer thickness from the
depth/thickness relation generated by FLAY and RLAY; do this by fractional
interpolation in a normalized depth/thickness table. Because the summation
formula is degenerate for RLAY=1, need some logic branches. Maintain total depth
in D units based on N1, FLAY and RLAY. Logic flow:
\\ - get $\Delta z$ in m from zone table
\qi -  If this is last zone, compute depth-to-go using a sum based on N1, FLAY, RLAY
\\ - Compute desired first layer of zone based on depth thus far in D units
\qi - If RLAY $\leq 1$ then $n=\Delta z /$ first in m 
\qi - else: use formula in normalized units
\\ - Round n to nearest integer
\\ - Recompute first layer based on integral number of layers
\\ - Loop on layers, increasing each by RLAY, keep track of $\sum$ in m and D units

$D=\sqrt{\kappa}\sqrt{P/\pi} = I/(\rho C_P)\sqrt{P/\pi}$.
\qi For typical geologic materials, $\rho C_P \sim $1.e6, and for a diurnal
period of 1 day, $D \sim I \cdot $ 1.7e-4 m

\qsd{Grott 2007 profile} I wrote a small IDL function that generates the
lunar-like conductivity and density profiles of \qcite{Grott07}, which were then
output at geometric series spacing close to KRC v3.4 normal; making the zone
table \nf{Grott07.tab}.

Using last layer as 15 yields a little nicer result than 14, which puts 2
layers in the last zone and has less efficient time doubling.

\subsubsection{Ensure stability}%.............. 

If the first layer would be unstable, then can adjust RLAY to generate a stable
BLAY and while not changing the total depth or the number of layers. No [easy]
analytic solution; must iterate to find RLAY.

Minimum safe first layer: BSAFE= $\sqrt{2 \kappa \Delta t }$ where $\Delta t = $ PeriodDays*86400./N2   If BLAY lt BSAFE, then can use IDL 
routine NUMGEOMLAY to find RLAY that will allow FLAY to yield the needed BSAFE:
\qi Compute the diffusivity $\kappa = k/( \rho C_P)$
\qi Compute the diurnal scale: $D=\sqrt{ \kappa P/\pi}$ where P is the spin period in seconds, = days*86400.
\qi Set the desired total depth in D units, Z \ =Z(meters)/D
\qi Set the desired number of physical layers N ( N1-1)
\qii One way: 
\qi Set the desired FLAY in D-units or compute it as B/D where B is the first physical layer thickness in m.
\qi In IDL: yy=NUMGEOMLAY(Z,jint=N,flay=FLAY)  ; yy will be the needed RLAY
\qiii Z must be real, not integer.

Can add the following to .inp file, then will run very quickly and produce a layer table. 
\vspace{-3.mm} 
\begin{verbatim}
2 5 2 'N5' / few seasons THIS AND BELOW USED WHEN TESTING layer structure
2 4 1 'N4' / single latitude (beware if more than one latitude row)
\end{verbatim}  

\section{Photometric Function Details \label{photo} \label{Ah}}

\input{v34p.tex} %<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<

\clearpage
\section{Heat flow Details \label{hfd}}

\subsubsection{Lower boundary}
 To stay in the numerical scheme of KRC, impose upward basal heat flow of $H_g$
 by setting \qbn T_{n+1}=T_n+\frac{H_g (B_n+B_{n+1})}{2 k_n} \ql{H1} This value
 is constant for all latitudes and seasons of a single case.

\subsubsection{Upper boundary}
No change to numerical iteration, but starting conditions can include expected
effect.

Modified from KRC paper, equation number in [13] there has additional term on
the right, $+H_g$.

Surface radiation balance, from Eq.[13] for a flat surface with sub-surface heat
flow $H_g$; revised [12] :
\qbn \epsilon \sigma  \langle T_s^4 \rangle =(1.-A) \langle S_{(t)}' \rangle +H_g 
+ \epsilon \sigma  \beta_e \langle T_a^4 \rangle  \ql{Hs}

This will be further revised with the inclusion of photometric functions, see \S 
\ref{eqT} .
Expansion of $ \langle H_R \rangle$ using Eq. [5] and a combination of Eqs. [10]
and [13], yields revision of [12];

\qbn  \langle T_a^4 \rangle = \frac{ \langle H_V \rangle / \beta_e + (1-A) \langle 
S_{(t)}' \rangle + H_g} { \sigma (2- \epsilon \beta_e) }  \ql{Ha}


\subsubsection{General relations}

 Heat flow at any time between any two layers, Layer i of thickness $B_i$,
 conductivity $k_i$ and temperature$T_i$ and the next deeper layer with values
 $B_+, \ k_+$ and $T_+$. Assume the temperature holds at the middle of each
 layer. Equating the heat flow in the adjacent 1/2 layers so that no energy goes
 into the interface at temperature $T_p$: \qbn H_i=\frac{k_i}{B_i/2}(T_p-T_i)
=\frac{k_+}{B_+/2}(T_+-T_p)= H_+ \ql{H4} 
yields; \qbn T_p=\frac{ k_iB_+T_i \ + \ k_+B_iT_+ }{ k_iB_+ + k_+B_i} 
\mc{or} T_p= \frac{T_i+fT_+}{1+f} \mc{where} f=\frac{k_+B_i}{k_iB_+} \ql{H5} 
Use either of the first relation to get heat-flow; the first yields 
\qbn H_i=\frac{k_i}{B_i} \frac{2f}{1+f} (T_+-T_i) \ql{H6}

However, the values will be near the geothermal
 level only well below the annual skin-depth.

\subsubsection{General expectation}
Compared to a model without heat flow, for which the diurnal mean surface
temperature is $ \epsilon \sigma T_m^4= S_o f(1-A)/U^2 $ where $f$ is a
``garbage'' factor that accounts for the effects of illumination geometry and
the atmosphere; with steady geothermal heat-flow $H_g$ would expect a diurnal mean
surface temperature $ \epsilon \sigma T_H^4= f S_o (1-A)/U^2 + H_g $ , some
manipulation leads to a change in the average surface temperature: 
\qbn T_H-T_m \simeq H_g/ \left( 4 \epsilon \sigma T_m^3 \right) \qen   
The effect will be larger at night and less in the day. With depth, the average 
temperature increase for layer $j$ is, 
\qbn \overline{T_{Hj}}- \overline{T_j}\approx + \frac{H_g}{k} \left[ \sum_{i=2}^{j-1} B_i \ + B_j /2 \right] \qen 
where $B_i$ is the thickness of KRC layer $i$ in meters.

\subsubsection{Slow convergence}

KRC starts with an isothermal profile.  Heat-flow induces a thermal slope which grows from the lower boundary.  

Characteristic time for a slab of thickness $l$ is $l^2/\kappa$

\qcite{Carslaw59} [CJ] section 3.4 discusses a region $-l <x<l$ with zero
initial temperature and with the $x=\pm l$ kept at constant temperature $V$ for
$T>0$''. Apart from the imposition of a linear gradient, this region $0<x<l$ is
similar to starting KRC isothermal and imposing a constant heat-flow that in
infinite time would increase the lower boundary by $V$.  Introducing the
dimensionless parameters $T=\kappa t/ l^2$ and $\xi=x/l$ (all this is CJ
symbols) yields solution for the temperature increase $v_{(T,\xi)}$ in the form

\qbn \frac{v}{V}= 1-\frac{4}{\pi} \sum _{n=0}^\infty \underbrace{
  \overbrace{\frac{(-1)^n}{2n+1}}^{a}e^ {\overbrace{-(2n+1)^2\pi^2/4}^{b} \cdot
    T}}_{p1} \underbrace{ \cos \overbrace{\frac{(2n+1)\pi}{2}}^{c} \xi }_{p2}
\mc [3.4.4]\qen and the family of solutions is shown in CJ Fig 11 (p. 101),
which I have recalculated [IDL routine qkrcsimp.pro] and show in Fig
\ref{CJFig11}; the under- and over-braces indicate grouped terms in my numerical
solution.

\begin{figure}[!ht] \igq{CJFig11}
\caption[Thermal diffusion from one boundary]{Temperature distribution over time
  for a slab with a jump in one boundary.Ordinant is fraction of the temperature
  rise to final state; abscissa is fraction of the way into the slab. Curve
  values shown in the legend are normalized time: $\kappa t/ l^2$. See text.
\label{CJFig11} CJFig11.png  }
\end{figure} 
% how made:  qkrcsimp first section

If a KRC model is thick enough to attenuate the annual cycle (about 4 times the
annual skin depth, $l=4D_y$ and $D_y=\sqrt{\kappa \frac{P_y}{\pi}} $. Then, to
reach 90\% effect, need $T=1$ or $t=l^2/\kappa \Rightarrow t=16 P_y/\pi$, or
about 5 years.

A relatively quick way to approximate heat-flow models is to compute a KRC model
with no heat-flow, estimate the change in surface temperature and the thermal
gradient on the model soil stack using the thermal conductivity profile and add
these to the KRC no-heat-flow model.

\subsubsection{Issues ?? CHECK \label{issu}}  % ---------------------------------
\begin{enumerate}    % numbered items 
 \item 
Heat flow determined from KRC run output temperatures does approach the
lower-boundary input values. However, when IC2 invokes a second material, get
only about 80\% of the expected heat flow. Have not found the cause of this.
 \item 
Ts differences for the two T-dep cases are up to about 1K at the equator and 2K
for $\pm 60$\qd.

Convergence test for the lower material in Version 2 was against CONVG, so a
large value generated thick layers in the lower material; inappropriate.  V34
cannot reproduce the exact layer and time-doubling configuration of V23. Yet,
the remaining difference are much larger than expected. See the working document
\nf{V33issues.tex}

\end{enumerate}
\input{fard}  %<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<

\section{Plans for next release \label{plans}} %_____________________________

Current concept for thermal beaming is as a post-run process and as such has no
impact on KRC.

``Moon-ready'' KRC will require changes to several of the KRC commons, and will
require an additional loop to handle longitude. This will be a major
restructuring.


\section{Error codes}
 The code-set has progressed toward a consistent usage: IRET is the return code argument in a routine,
 IRL is the name in a call to a lower routine.

\np{TCARD}: 1 = normal start    2 = restarted from disk record
\qi   3 = continue from current conditions  4 = Switch to "one-point" mode
\qi   5 = END of data (no more change cards) in input file
\qi   6= Error reading internal buffer  7= End while reading internal buffer

\np{TDAY}:   1=normal return   \np{TDAY}(2, 2=numerical blowup 
\qi  \np{TDAY}(1,  3=Some layer unstable  4=Too many Layers generated by zone table

\np{TLATS}: 
\qi  1=normal   2,3,4= error of same number in \np{TDAY} 
\qi  C  5=no matching latitude in fff

\np{TSEAS}: returns from: 
\qi  \np{TCARD}(2: if $>5$, then +10   4=switch to onePoint  5=End of input file
\qi  \np{TDAY}(1   if $\ne 1$, then +20 
\qi  \np{TLATS}    no change
\qi  \np{TFAR}     41: Tatm needed but not in the fff.

\np{KRC}: 
4=PARAMETER ERROR IN TDAY(1)
\section{Test runs  \label{t1} } 

Because of the extensive testing done with KRC version 321, see "KRC version 2
and 3: Thin/deep layers and long runs", that is considered the base for testing of
later versions.

\subsubsection{ A: Obsolete} %.......................
Test Run A is primarily a body in Mars orbit with no atmosphere; it used a
2-year spin-up followed by 1 year that is saved. It had 15 cases defined in
\nf{krc33.inp}, produced \nf{M33A.prt} and \nf{M33A.t52}; the differences in
diurnal temperatures from case 0 for the last day of the last season are shown
in Figure \ref{kv782M33A}.  Case 0 had: No atmosphere, was homogeneous with
depth, used 44 layers and Lambert albedo. Differences from this case are listed
below:
\qi 1: Normal Mars with atmosphere and Lambertian soil. Two materials
\qii TUN radiance output to fort.77, renamed to \nf{M33A.77}
\qi 2: Lommel-Seeliger albedo
\qi 3: Minnaert=0.7 albedo 
\qi 4:  1 W/m2 heat-flow
\qi 5:  2nd material at IC2=9 
\qi 6:  2nd material at IC2=9,  1 W/m2 heat-flow
\qi 7:  30 layers
\qi 8:  30 layers, 1 W/m2 heat-flow
\qi 9:  30 layers , KofT
\qi 10: 30 layers , KofT, 1 W/m2 heat-flow
\qi 11: less time doubling
\qi 12: no time doubling
\qi 13: zone table: zoneX (similar to 2 materials)
\qi 14: zone table: zoneY (exercise most table options)

\begin{figure}[!ht] \igq{kv782M33A}
\caption[Test run A]{Diurnal surface temperature in Version 3.3 test run A at
  the last season (Ls=0) at latitude 0 relative to the first case. Difference in
  cases described in the text.
\label{kv782M33A} kv782M33A.png }
\end{figure} 
% how made: input krc33.inp, jlat=0, kv3 139,123

Test Run B is basically the Version 3.3 standard for 3 latitudes: 0, -30 and
-45; with the 2nd material starting with IC2=7, used 44 layers and Lambert
albedo, had a 2 year spin-up and ran for a total of 20 years. It had 12 cases
defined in \nf{krc33B.inp}, and produced \nf{M33B.prt} and \nf{M33B.t52}.
%; the differences in diurnal temperatures from case 0 for the last day of the last season are shown in Figure \ref{kv782M33B}.  
Case 1,7: are the version 3.3 standard Mars homogeneous with depth; the second
case number is with 100 milli-Watt/m$^2$ geothermal head-flow. Case differences
from this are listed below: (1-based index)
\qi 2,8: Two materials with IC2=7
\qi 3,9: use T-dep materials
\qi 4,10: Two materials with IC2=7 and use T-dep materials
\qi 5,11: zone table: zoneX (similar to 2 materials)
\qi 6,12: zone table: \nf{Grott07.tab}, which follows \qcite{Grott07} with their higher conductivity

Heat flow of 100 milli-Watt/m$^2$ is about a factor of 3 higher than expected for
Mars, but chosen to make the effects of heat-flow easier to see in plots.

The effect of heat flow is shown in Figure \ref{kv7847}. The effect of
20mW/m$^2$ is 1K at about index 36, KRC layer 38, depth 2.7m .

\begin{figure}[!ht] \igq{kv7847}
\caption[InSight with heat-flow]{Temperature versus depth for a model similar to
  the higher conductivity model of \qcite{Grott07}, but at latitude 30S which
  has larger seasonal variation than the planned InSight landing area.  Abscissa
  is 0-based physical layer index, which is roughly proportional to the log of
  depth. Ordinate is temperature. First 4 curves are without heat-flow and the
  second 4 with heat-flow of 20 mW/m$^2$; the sets virtually overlay for index
  less than 25. Of each set, the first 2 are at the cold season, Ls=93\qd;
  second 2 at the hot season, Ls= 240\qd. Of each pair, the first is the minimum
  diurnal temperature and the second is the maximum. Colors lower in the legend
  can overwrite those above.
\label{kv7847} kv7847.png  }
\end{figure} 
% how made: krc33B.inp M33B.t52, last two cases. kv3.pro @ 139,123 then 7847

\subsubsection{nill Atmosphere} %.......................

A test of the progression toward low atmosphere pressures was run, 342c.  One
must be careful to ensure that the Photometry parameter ARC2/PHT is 0 for the
nill-Pressure case to ensure that it is Lambertian, as the atmosphere cases are
forced to be Lambertian in the TLATS code.

Results are shown in Figure \ref{622c} 
\begin{figure}[!ht] \igq{622c}
\caption [Effect of an atmosphere]{Surface temperatures as a function of
    atmospheric pressure; Mars seasonal variation of the equator at 13 hours
    after a t2-year spin-up. Solid lines are V342, long dash are V321. White is
    standard mars conditions with constant pressure, blue is pressure following
    the Viking lander annual variation. Green, yellow and red, are constant
    pressures of 1/10, 1/100 and 1/500 Mars, reducing the dust opacity and the
    \qcc background opacity by the same fraction.  Purple is also .1/500 Mars
    (1.1 mBar) but with dust \qcc background opacity both set to zero; orange is
    no atmosphere.
\label{622c}  622c.png }
\end{figure} 
% how made: 


\subsubsection{Version tests} %.......................
Standard comparison of version 321 and 342 was with a set of 5 latitudes for
every sol with 15 layers and no spin-up, Figure  \ref{342soly-321}; runs had 
the same six cases:
\qi 1: base=Mars std atmosphere, surface with T-constant properties
\qi 2: as case 1, but with T-dependent properties
\qi 3: as case 1, with T-con. but with variable frost temperature and albedo
\qi 4: no atmosphere, Lambertian, T-constant properties
\qi 5: as case 4, but T-dep. properties
\qi 6: as case 5, but the T-dependence set to zero

A second standard comparison used 20 layers for 19 latitudes for 40 seasons after a two-year spin-up but only case 1; Figure  \ref{342vt2-321}).

For both of these runs,  CONVF was 2 for V321, yielding lower layer of time doubling  2    4    6    8   10   12   14   15or20;  and CONVF was 3 for V342, yielding  4  5  7  9 11 13 15 [20].

A run of 5 latitudes with 20 layers for 40 seasons after a two-year spin-up but 
CONVF=3 for both versions, yielding lower layer of time doubling  4    5    7    9   11   13   15   20 for both versions, had smaller differences: Figure \ref{kv57}

 
\begin{figure}[!ht] \igq{342soly-321}
\caption[V342-V321 for each sol]{Difference of surface temperature for V342-V321 for each sol for five latitudes as shown in the legend. See text.
\label{342soly-321} 342soly-321.png }
\end{figure} 
% how made: kv3: @114 2 321 342, @115, @123, @56 t 0, @561, @57

 
\begin{figure}[!ht] \igq{342vt2-321}
\caption[V342-V321 for 19 latitudes]{Difference of surface temperature for V342-V321 for 19 latitudes for a runs with 20 layers for 40 seasons after a two-year spin-up. 
\label{342vt2-321}  342vt2-321.png }
\end{figure} 
% how made: kv3: @114 3 321 342, @115, @123, @56 t 0, @561, @57


Matching with version 232, 321 and 342 were done using for 5 latitudes (-60,
-30, 0, 30, 60), 40 seasons with a 2-year spinup, 20 layers with similar time
doubling ( Lower layer of time doubling: 4 5 7 9 11 13 15 20 for V321 and V342; 4
6 8 10 12 20 for V232) were done for representative Martian physical properties; 
I=200 over ice begining at 6 cm. Each run had the same 8 cases:
\qi 1: base=Mars std atmosphere, surface with T-constant properties
\qi 2: as case 1, but with T-dep. properties
\qi 3: as case 1, but with variable frost temperature and albedo
\qi 4: as case 1, but 30 \qd~ slope to 90\qd~ azimuth (West) 
\qi 5: no atmosphere, Lambertian, T-constant properties
\qi 6: as case 5, but T-dep. properties
\qi 7: as case 6, but the T-dependence set to zero
\qi 8: as case 5, but 30 \qd~ slope to 90\qd~ azimuth (West) 

Run times: 232= 2.445 sec,  321= 3.036  341= 3.0445

Differences in Tsurf are shown in Figures \ref{kv57}, \ref{kv571} and
\ref{kv571b}. The difference for T-dep cases results from small changes in the
layer thicknesses as discussed in the Alert in \S \ref{need}.

\begin{figure}[!ht] \igq{kv57}
\caption[V342-V321]{V342-V321 for 8 cases. Abscissa is hours * season *
  case. Ordinant is Tsurf of 342 - 321.  Five cases have differences less than
  about 0.1 K, apart from winter frost edges. Those with T-dep properties have differences are up to 1.5 K, apart from frost edge.
\label{kv57}  kv51.png }
\end{figure} 

\begin{figure}[!ht] \igq{kv571}
\caption[V342-V321, attenuated]{Same as Fig. \ref{kv57}. Cases with large excursions are shown attenuated by factors listed in the figure.
\label{kv571}  kv571.png }
\end{figure} 
% how made:  kv3 114, 4 321 342, 115, 123, 13 10=0, 56 t 0, 561, 57, 571
 
\begin{figure}[!ht] \igq{kv571b}
\caption[V232-V321]{V232-V321 for 6 cases. See caption for Fig.  \ref{kv571}
  Abscissa is hours * season * case. Ordinate is Tsurf of 232 - 321.  Four
  cases with no atmosphere have differences less than about 0.1 K, those cases
  with atmosphere are shown attenuated by a factor listed in the figure; the
  differences are up to 3.2K, apart from seasonal cap edge.
\label{kv571b}  kv571b.png }
\end{figure} 
% how made:  kv3 114 4 321 342 115 123 570 571

DownVis: 342-321 has deltas up to 8 for the atm. cases.  Unexplained.
\qii looks like revised amplitude.  but ratio largest at noon, and varies with season
\qi 232-321 has deltas up to 15 that resemble the delta Ts.
\qi no-atm. cases identically zero


DownIR: 232-321: delta up to 8 for the atm cases.

 @570 342b-321 lat=0, last season:
\qi Ts:  case 2 and 5 ( T-dep) 0.4K cool in morning, 0.8K hot after dusk
 \qi Insolation low by up to 80 at noon
\qiii 342b-321, deltas at roundoff.
 downir  deltas largest for case 2, and 3:5 all the sma.

 342c: downir values for 341 seem to be the same for all cases! Fixed
\qii downir is ATMRAD

 
\vspace{-3.mm} 
\begin{verbatim}

KRCINDIFF: test for changes. Input limits:       64     120     220
                    V342       V321
out  i    Label     Arg1       Arg2       Arg1-Arg2
 34 33     FLAY     0.21600     0.18000    0.036000 < but yields same layers
 65 64     HUGE 1.0000e+308  3.3000e+38 1.0000e+308
 66 65     TINY 1.0000e-307  2.0000e-38 -2.0000e-38
 67 66   EXPMIN      700.00      86.800      613.20
 71 70   TATMIN      143.39      143.39 -1.4859e-05
 72 71     PRES      912.60      912.60  -0.0020989
 73 72  OPACITY     0.50143     0.50143 -1.1532e-06
 74 73    TAUIR     0.30921     0.30921 -7.1116e-07
 75 74   TAUEFF     0.61843     0.61843 -1.4223e-06
 76 75    TATMJ      165.99      165.99 -0.00011073
 82 81   TEQUIL      154.52      194.78     -40.258  < ??
 85 84   SCALEH      8.2048      8.2047  3.7947e-05
 86 85     BETA     0.46121     0.46121 -7.6633e-07
117 16    K4OUT      -2      52     -54
118 17    JBARE    9999       0    9999

Using Aug 30 13:35 tlats; 
 82 81   TEQUIL      192.24      194.78     -2.5368


321----------
      AVEA=ALB ! surface albedo; will be frost if frosty at end of prior day
      AVEI=AMAX1((1.-AVEA)*AVEI/DFLOAT(N2),0.) ! average absorbed insolation
      IF (LATM) THEN            !v-v-v-v-v  with atmosphere
        TSEQ4=BETA*TAEQ4+AVEI/(SIGSB*AVEE) ! equilib T_s^4
        TEQUIL = AMAX1( TSEQ4,1.D4)**0.25D0 ! equilib T_s, min of 10.
      ELSE                  ! no atmosphere
        TEQUIL = ((1.D0-AVEA)*AVEI/(SIGSB*AVEE))**0.25D0 ! equilib T_s

342----------
      AVEA=ALB ! surface albedo; will be frost if frosty at end of prior day

      IF (LATM) THEN            !v-v-v-v-v  with atmosphere
        PHOG=0.                 ! force to be Lambert
        KOP=1                   ! Lambert flag
      ELSE                  ! +-+-+-+-+  no atm. may use photometric functions
        PHOG=ARC2               ! reassigned to be the photometric value

             AVEA=ALB*AHF   where AHF is photometric factor, =1 for Lambert
      AVEI=AMAX1((1.-AVEA)*AVEI/DFLOAT(N2),0.) ! average absorbed insolation
      IF (LATM) THEN
        TSEQ4=BETA*TAEQ4+(AVEI+GHF)/(SIGSB*AVEE) ! equilib T_s^4
        TEQUIL = AMAX1( TSEQ4,1.D4)**0.25D0 ! equilib T_s, min of 10.
      ELSE                  ! no atmosphere
        TEQUIL = (((1.D0-AVEA)*AVEI+GHF)/(SIGSB*AVEE))**0.25D0 ! equilib T_s


from 232 to 321 to 342, Tlats grew from 480 to 506 to 679 lines
 tday:  569 to 487 (deletion of many debug) to  823


2016 Sep 2 18:45:40 check processing of  232 .t52 versus .tm1
a) kv3 @114 4 232 321 @11 6=V232test2 17=.tm1   @201 202 207 @252 
    @12 0=23 23=-1 @50  @51 -> 0   @53
b)  kv3 @114 4 342 342  @11 17=.tm2  @201 202 207 @252
    @12 0=43 23=-2 @50  @51 -> 0   @53
All identical.

         ___THICKNESS____    __CENTER_DEPTH__    Total  Converg.
 LAYER    scale     meter     scale     meter   kg/m^2  factor
    2    0.2160    0.0070    0.1080    0.0035    11.224   2.851  
   20   39.3144    1.2768  199.4641    6.4780  6639.141  15.790

         ___THICKNESS____    __CENTER_DEPTH__  Conductiv. Density Sp.Heat     Total Converg.
 LAYER  D_scale     meter   D_scale     meter      W/m-K   kg/m^3   J/kg     kg/m^2  factor

    2    0.2160    0.0070    0.1080    0.0035 0.3864E-01  1600.00  647.00    11.224   2.851
   20    5.7506    1.2768   30.5485    6.4780  2.770       928.00 1711.00  6639.141  15.790

    2    0.2160    0.0076    0.1080    0.0038 0.3951E-01  1600.00  568.17    12.112   2.851
   20    5.7506    1.4720   30.5485    7.4642  3.226       928.00 1499.21  7647.643  15.790

    
T-global= 190.09
\end{verbatim} 

\subsubsection{IDL notes \label{t2}} %.........................................
\begin{verbatim} 
.rnew kv3 
@114: 4, 321 342 ,  111 123 
@65  
@66:  46 48 55 (respond many 1) -2  to prepare for HALB comparison
@ 661
@ 651 662 

@402   CLOT DownVis then Tsur for all cases
@56  t 0    Select array and item
@561        Prepare the difference
@562        Stats versus latitude
@563        QUILT3 and make dd

CLOT,reform(qy[*,0,0,*])

CLOT,reform(ttt[*,0,2,3,*]),caset,locc=1  DIurnal T, equator, one season, all cases

@12 7=0 8=1  check effect of TAUD and CABR when no atm, 
@ 56 561 ...result == 0
@12 7=-1 8=0 compare to lambert
@13 9=0 not absolute
@ 56 561 
 clot,reform(ttt[*,0,2,3,*]),caset,locc=1
 clot,reform(ttt[*,3,2,3,*]),caset,locc=1
\end{verbatim} 

%\clearpage

\bibliography{heat,moon,mars}   %>>>> bibliography data
\bibliographystyle{plain}   % alpha  abbrev 

\appendix %=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=

\section{Lunar albedoes \label{LA} }

\subsection{Email from Sylvain}
\vspace{-3.mm} 
\begin{verbatim}
05/05/2016 04:18 PM

As I am diving in the new KRC capabilities (photometric functions,
temperature-dependent properties at depth, etc.) as well as what's potentially
missing for airless bodies, there is this one other thing that bugs me:

KRC can now use a choice of surface photometric functions (Minnaert, etc.) but
an integration is necessary to turn each one of the chosen function into
hemispherical reflectance = surface albedo that depends on solar incidence. I
started to think more about these things after seeing a presentation for a
student of David Paige that compared hemispherically integrated photometric
functions from lab measurements vs. theoretical formulations and existing
formulation (Keihm 1984 and others).

I can't figure out where in KRC this integration is done, but more importantly,
why not using a Kheim1984-like formulation which actually directly gives the
hemispherically integrated albedo as a function of solar incidence (i.e. the
integration is already done for us, without having KRC doing it) as opposed to
-as of now- the photometric function that must be integrated by a black box (to
most users unless they look at the KRC codes) in KRC?

This way, the user would directly provide a and b (from Keihm 1984 Eq. A5) as
inputs, which would directly lead to the surface albedo, without relying on KRC
for the intermediate hemispherical integration. Again, a and b are from Equation
A5 in the Keihm paper we discussed a few months ago (attached with this email)
and would be the 2 input provided by the user. Is there a reason not to do that?

And while I am looking at the Keihm paper and some of my old notes from a
telecon last year with you and Phil, I wrote that KRC could integrate a
temperature-dependent surface emissivity (Keihm, Eq. A4). Do you still believe
that an upcoming version of KRC could integrate that capability?

05/06/2016 09:25 AM

I think what is throwing me off is the opposite trends between the photometric
functions found in the general optical literature and the functions described by
the lunar folks.

The Minnaert/Lommel-Seeliger/other functions have the bond albedo decreasing
when the Sun gets closer to the horizon; the bond albedo derived from lunar
observations and laboratory work increase when the Sun gets closer to the
horizon. Vasavada et al. refined the Keihm 1984 formulation with new values for
a and b to best fit the Diviner data (See Vasavada paper Eq.(1) vs Keihm
A5). Also see a presentation by Emilie Foote and David Paige compiling
laboratory measurements (specifically the last 2 slides) also confirming the
opposite trends.

With a negative exponent, the Minnaert function can get somewhat close to the
Kheim or Vasavada formulation (except near the limb as you mention in the
documentation where the bond albedo > 1) but the current input system in KRC
cannot understand negative exponents (ARC2 < 0 => Lommel-Seeliger).

\end{verbatim} 

\subsection{Hemispheric Albedo}

In \nf{/work2/Reprints/} I have \qcite{Keihm84} as \nf{Lunar/Keihm84.pdf}, 
\qcite{Vasavada12} as  \nf{ Photom/Vasavada12Lunar.pdf} 
and the Foote and Paige presentation as \nf{Photom/Foote13DivinerOxford.pdf} .

 \qcite{Keihm84} has (equation A5): 
\qbn A(\theta)= 0.12+0.03 \left( \theta/45\right)^3 + 0.14 \left( \theta/90\right)^8 \qen

Extracts from \qcite{Vasavada12}

 \S 3.1 [25]: \ `` Within this constrained data set, we find that for darker
 surfaces, the dependence of reflectance on phase angle can be removed by
 dividing by$\mu_0^{1.3}$ . This is a slightly stronger dependence than for a
 Lambertian surface (i.e., dividing by $\mu_0$ ). It is difficult to assess its
 appropriateness for brighter surfaces due to (unresolved) surface slopes that
 cause higher levels of scatter in the data.''

 \S 5.2  [44]: \
`` Because
the Diviner solar reflectance data used in section 3.1 are
measured normal to the surface, they cannot be used to
define the full bidirectional reflectance of the surface. But
daytime temperatures, being close to radiative equilibrium
with the instantaneous insolation, can be used to infer the
angular dependence of albedo. We find that the Apollo-derived 
formulation of Keihm [1984] reproduces the observations well, where

 \qbn A(\theta)= A_0 + a\left( \theta/45\right)^3 + b\left( \theta/90\right)^8, 
\ \ \ (1) \qen 

and $A_0$  is our Diviner normal albedo at each longitude. We
derive a best fit value of $a$ = 0.045 (modified from 0.03) and
keep Keihms value of $b$ = 0.14 .''

Converting to a normalized form:

 Can represent Keihm as  \qbn A(\theta)= 0.12\left[ 1.+0.25 \left(\theta/45\right)^3 + 1.17 \left( \theta/90\right)^8 \right] \qen


Vasavada would be, at least for $A_0=.12$,   \qbn A(\theta)=  A_0\left[ 1.+0.375 \left(\theta/45\right)^3 
+ 1.17 \left( \theta/90\right)^8  \right] \qen

 In TLATS, code as factor=$1+ f_1 \theta^3+f_2\theta^8$ where $ \theta$ is in radians and $f_1=x/(\pi/4)^3$ where $x$ is derived from the input parameter and $f_2=1.17/(\pi/2)^8$

Both are encoded into KRC 3.4 by over-using the single available photometry parameter: -x: $0<x<1$  


In some later version of KRC, isolate several input parameters to handle
hemispheric albedo. Possible form:

\qbn A(\theta)=c_0 \left[ 1.+ c_1 \left( \theta/45 \right)^f + c_2 \left( \theta/90 \right)^g \right] \qen

\subsubsection{Foote}

We have developed a simplified BRDF function that takes the following form:
\qb REFF (i,e,g) = \frac{2X}{\mu_0 + \mu + Y} \left( 1 + B(g) \right) p(g) \qe
Where X and Y are constants.
 
Where \qbn B(g)=\frac{b_0}{1+\frac{\tan(g/2)}{h}} 
\mc{and} p(g)=\frac{(1-c)(1-b^2)}{\left( 1+2b\cos(g)+b^2\right)^{3/2}} +\frac{c(1-b^2)}{\left( 1-2b\cos(g)+b^2\right)^{3/2}} \qen

Adjustable parameters: $b, \ b_0, \ c, h, \ Y, \ X$ . 


\subsubsection{Birkebak Apollo samples}

Birkebak measured hemispherical albedo (reciprocal method) of several Apollo
soil samples; his term is ``directional reflectance'', \qcite{Birkebak70} and
\qcite{Birkebak74} .

Spectral observations were made at 15,30,45 and 60\qd, weighted with the solar
irradiance and fit with polynomials in $i$ up to 6'th degree; \qcite{Birkebak74}
Tables IV and V list the coefficients.  However, the analytic expressions were
forced to go thorough unity at 90 degrees.  The analytic fits are shown in
Figure \ref{Birk3}

His Table III lists ``solar albedo'' at six discrete incidence angles from
earlier work; these are shown in Figure \ref{Birk2} and Figure \ref{Birk3}

\begin{figure}[!ht] \igq{Birk2}
\caption[Lunar albedo]{Solar albedo for specific incidence angle, from Birkebak table III. Lines omitted across missing data.
\label{Birk2} Birk2.png  }
\end{figure} 
% how made: hemialb @21
\begin{figure}[!ht] \igq{Birk3}
\caption[Lunar albedo, normalized]{Solar albedo for specific incidence angle,
  Data same as Figure \ref{Birk2}, but normalized to values at $i$=30\qd. Apollo
  12 with density 1600 seems wayward.
\label{Birk3} Birk3.png }
\end{figure} 
% how made: hemialb @ 22

 Some of the published fits pass through all the data points, others have up to
 about .01 residuals, but most have too much curvature to look realistic.


\subsubsection{My try at fits. FUTURE} %.

Not many data points, so can't use many coefficients

$A_h=A_0(1.+ c_0 (\theta/90.) ^{c_1}) $, one non-linear term, can use BRENTX
See what the family of curves looks like.
Begin coding: hemialb.pro @71

\section{Effect of photometric function}

Results for each type of photometric function in KRC v3.4.x are shown in Figures
\ref{kv402v} and \ref{kv402}. Some normalization is missing for
Lommel-Seeliger. The Vasavada relation appears unrealistic.
 
\begin{figure}[!ht] \igq{kv402v}
\caption[DownVis for photometric functions]{Downward solar flux at the surface
  for different photometric functions, no atmosphere. First case (in legend,
  from the top) is Lambertian (2nd is same, testing no atm), third is
  Lommel-Seeliger, 4th and 5th are Minnaert with k= 0.7and 0.3, 6th is Keihm,
  7th is Vasavada.
\label{kv402v}  kv402v.png }
\end{figure} 
% how made: run test342k, kv3 @111 402
 
\begin{figure}[!ht] \igq{kv402}
\caption[Tsurf for photometric functions]{Surface temperature for a lunar
  material (I=50, no atmosphere, Mars orbit and length of day) for different
  photometric functions. Different curves as identified in Fig. \ref{kv402v}.
\label{kv402}  kv402.png }
\end{figure} 
% how made: run test342k, kv3 @111 402

\section{Tuning} 

Using a nominal Mars case for I=300 with a year of 40 seasons after a 2-year
spin-up; latitudes 0, -30 and -45\qd ~as the southern hemisphere as the more
extreme seasons. Tried various geometric ratios RLAY and number of layers N1;
FLAY was adjusted so that the bottom depths are all the same.

%Input: mtime.inp, to mtimeD.prt.

Ran a case with the maximum number of layers, RLAY= 1.12, and 8-fold increase in
times steps as the reference, which takes about 8 times as long to run. Case
inputs and results for 30\qd S are in Table \ref{tuneTab}; Temperature through
the day of the last season are shown in Figures \ref{kv782Dm30} and performance
is in Figure \ref{kv782bDm30}.

\begin{table} 
\caption[Tuning cases]{Cases for the tuning run. 'Deep' is depth to the bottom
  in units of D; 'Sconv' is the average convergence safety factor; 'secs' is the
  execution time for the case (all lats and seasons); MAR is the mean absolute
  residual of surface temperature for 30\qd S; 'Tdel' is the temperature
  difference at 7 Hours. The first 3 cases are identical except for CONVG, and
  are cases 3:5 3. Case 6 has 1/2 the time steps. Case 7 is similar to case 2,
  but must use a larger first layer and smaller RLAY because of the larger
  time-step. Last are 3 sets of constant RLAY, each with increasing number of
  layers. }  \label{tuneTab} 
\begin{verbatim}
 i  RLAY  FLAY CONVF  N1    N2   Deep  Sconv   secs    MAR   Tdel
 0 1.120 0.063  3.00  50 12288 134.36   7.69  6.388  0.000  0.000
 1 1.120 0.063  2.00  50 12288 134.36   7.69  6.088  0.007 -0.006
 2 1.120 0.063  1.00  50 12288 134.36   7.69  5.696  0.028 -0.004
 3 1.150 0.100  1.00  39  1536 134.36   2.44  0.791  0.084 -0.106
 4 1.150 0.100  3.00  39  1536 134.36   2.44  0.921  0.054 -0.133
 5 1.150 0.100  2.00  39  1536 134.36   2.44  0.884  0.053 -0.143
 6 1.150 0.100  2.00  39   768 134.36   1.22  0.487  0.129 -0.359
 7 1.100 0.127  2.00  50  1536 134.36   3.95  0.927  0.038 -0.073
 8 1.120 0.124  2.00  44  1536 134.36   3.78  0.884  0.038 -0.075
 9 1.120 0.099  2.00  46  1536 134.36   2.39  0.954  0.061 -0.150
10 1.120 0.079  2.00  48  1536 134.36   1.52  1.016  0.078 -0.198
11 1.150 0.115  2.00  38  1536 134.36   3.24  0.852  0.043 -0.098
12 1.150 0.100  2.00  39  1536 134.36   2.44  0.884  0.053 -0.143
13 1.150 0.076  2.00  41  1536 134.36   1.39  0.951  0.070 -0.205
14 1.200 0.114  2.00  31  1536 134.36   3.16  0.781  0.053 -0.092
15 1.200 0.095  2.00  32  1536 134.36   2.19  0.813  0.062 -0.155
16 1.200 0.079  2.00  33  1536 134.36   1.52  0.844  0.069 -0.197
\end{verbatim}
\vspace{-3.0mm}
\hrulefill \end{table}  
\begin{figure}[!ht] \igq{kv782Dm30}
\caption[Tuning for accuracy]{Results for I=300 on Mars with 40 seasons after a
  2-year spin-up. Run mtimeD; 17 cases, most with 1536 times per sol, referenced
  to 12288 times per sol with CONVG=3. Legend columns are: 0-based case index,
  RLAY, FLAY, CONVG, N1, N2, bottom depth in units of D.
\label{kv782Dm30} kv782Dm30.png  }
\end{figure} 
% how made: kv3.pro, 138, 123

\begin{figure}[!ht] \igq{kv782bDm30}
\caption[Accuracy versus time]{Efficiency results for similar homogeneous cases;
  abscissa is log of execution time for the case (all latitudes and seasons),
  ordinate is the Mean Absolute Residual (MAR) of surface temperature for 30\qd
  S relative to the reference case.
\label{kv782bDm30} kv782bDm30.png  }
\end{figure} 
% how made: as above

 Efficiency is basically displacement down perpendicular to the dotted line in
 Fig. \ref{kv782bDm30}. Cases 7,11 and 14 are similar, with case 8 being the
 best (cases 5 and 12 identical).  The fine time-step cases show that reducing
 the convergence safety factor in this case saves about 0.30 sec (5\%) for each
 reduction of 1, with small MAR, 7 mK, for the first and another 21 mK for the
 second. Cases 3,4 and 5 tested the same CONVG changes, also indicating that the
 major performance improvement is going from CONVG of 1 to 2.

Although the MAR for all 3 latitudes are similar, the generality of these
results has not been explored.



\end{document} %===============================================================

2016 Aug 26 16:08:21 

  0 VerA=new DIR    200 = /home/hkieffer/krc/tes/out/
  1  " case file   202  = V342test1
  2  " multi stem  203  = V331test2
  3  " OnePoint [.prt]  = V331Mone
  4  " DIR for prt      = /home/hkieffer/krc/tes/
  5 VerB=prior DIR 201  = /work2/KRC/232c/run/out/
  6  " case file   202  = V232test1.t52
@115 123 570  large diffs.

2016 Aug 26 17:01:33 Generate new 342v3t.inp, Total time [s]=   2.6575961
  Lower layer of time doubling:   4  5  7  9 11 13 15 20
 --v3tb after many changes in tlats8   [s]=   2.6375990 


also  run v321  Total time [s]=   2.5516119
  Bottom layers for time doubling:     4    5    7    9   11   13   15   20
 
also run 232    Total time [s]=    t4=2.1016800
  Bottom layers for time doubling:      2    4    6    8   10   20
     -t4  with CONVF=4,                 4    6    8   10   12   20

321 342: Num lat*seas*case with NDJ4 same/diff=     1118          82   


kv3  @114: 4 321 342  @11 0=/home/hkieffer/krc/tes/out/
@115 123
@12 6=1 17=29  -30 at largest insolation




321 - 232
Num lat*seas*case with NDJ4 same/diff=        1110          90

diff 232:321 .prt shows nothing unexpected!

56,561 for difference of any arry, lats, seasons

570 difference 2 runs


@12 pari: data ranges
@13 parj: QUILT ranges and 
@14 paru: tolerances on KRCCOM item deltas
@140 park: list of cases @785
@15 parp: 4 sets of plot ranges   157=VEC2CODE
@16 parr: 3 sets of plot ranges   167=VEC2CODE
@17 parg: KRC input values
%======================================
Figure \ref{}  
\begin{figure}[!ht] \igq{}
\caption[]{
\label{}  .png }
\end{figure} 
% how made:


\begin{table} \caption[]{}  \label{}
\begin{verbatim}
---
\end{verbatim}
\vspace{-3.0mm}
\hrulefill \end{table}  


