\documentclass{article} 
%% To see color:  Process with  pdflatex  and display with  pdf
% \usepackage{graphicx} % should allow jpeg or png

%% B&W shows but color will be empty: Process with  latex  and display with  xdvi
%\usepackage{epsfig} 
\usepackage{ifpdf} % detects if processing is by pdflatex
\usepackage{newcom}  % Hughs conventions
\usepackage{underscore} % accepts  _ in text mode

%\textheight=10.00in \topmargin=-0.5in
%\textheight=9.50in \topmargin=-0.5in
\textheight=10.0in \topmargin=-1.in
\textwidth=7.70in  \oddsidemargin=-0.7in \evensidemargin=-0.7in % 2012jan20 printest.tex

% Used in place of  \qen for development to identify equation labels 
%\newcommand{\ql}[1]{\label{eq:#1} \hspace{1cm} \mathrm{eq:#1} \end{equation}}
\newcommand{\ql}[1]{\label{eq:#1} \end{equation} } % for final

\title{Simple thermal model}
\author{Hugh H. Kieffer  \ \ File=-/krc/Doc/simple.tex  2015dec28+}
\begin{document} %==========================================================
\maketitle
\tableofcontents
\listoffigures
\listoftables
\hrulefill .\hrulefill
%\pagebreak 
\subsection{Introduction}
Write from scratch thermal model for single homogeneous material
with no temperature-dependence and no atmosphere to test against KRC.

 KRC run: no atmosphere, Fake the geometry matrix for circular orbit with same semi-major axis as Mars, but zero eccentricity and obliquity.

 Fiddle with declination of planets spin axis, but then discover that the BFRM matrix is all that matters; set its elements to 1. or 0. Then test print (LP2 true, set flags to print solar dec and half day at every latitude and season) 

 Test run has downvis at -60 same as at +60 all year, so obliquity must be zero.

\subsection{Take-away}
Should not allow time doubling in the first two physical layers.
For 0.1 K numerical accuracy, KRC runs should use finer layers than current standard and extend to depth of about 100 diurnal skin-depths

For a 2-year spin-up for Mars, best to have total depth of about 130 D (D= diurnal skin depth) 

\subsection{earlier studies}
-/cr/InSight/HP3/Thermod.tex  2014 March

-/krc/Doc/thin.tex  2014 May

\section{Formulation} 

Start with initial temperature profile, Compute average radiation flux for the first interval. Use this and T set from prior step to find new $T_S$, and then use that boundary condition to set the heat flow into the top layer for the next time step.

Thus, model times are at the end of the interval over which the boundary condition was averaged. With 0-based indexing and N times per sol; local Hour is 24*i/N .

With material properties the same for every layer, the JGR equations reduce to: 
 \qb (21)  \Longrightarrow \ \  F_{1_i} = \frac{ 2 \Delta t_i \kappa}{(1.+R) B_i^2} \qe
where $R \equiv B_+/B_i$ is RLAY. And 
\qb  (22)  \Longrightarrow \ \ F_{3_i}=\frac{1+R}{ 1+1/R} 
 \equiv \frac{1+R}{\frac{1}{R} (R+1)} \equiv R  \qe

Initial estimate: 
\qb  (11)  \Longrightarrow \ \ \langle T_s^4 \rangle =(1.-A) S_M\langle \mu_0 \rangle / \epsilon \sigma  \qe

Upper Boundary condition
\qb (13)  \Longrightarrow \ \ W=(1.-A) S_M  \mu_0  + k \frac{\partial T}{ \partial z}_{(z=0)} - \epsilon\sigma T^4 \label{eq:w} \qe

\qb (29)  \Longrightarrow \ \  \frac{\partial W}{\partial T} = -k / X_2 -4  \epsilon \sigma T^3 \qe 
 where $X_2$ is the depth to the center of the first soil layer. $X$ or $z$ increases downward.

No time division.  Set first physical layer to have thickness FLAY.

\qb (16)  \Longrightarrow \ \ \frac{\Delta T_i}{\Delta t} = -\frac{H_{i+.5}-H_{i-.5}}{B_i \rho C_p} \qe

Linear gradient between layer mid-points

\qb (17+3)  \Longrightarrow \ \ H_{i+,5}=- k \frac{T_+-T_i}{B_i/2 +B_+/2} \mc{and}  H_{i-,5}=- k \frac{T_i-T_-}{B_i/2 +B_-/2}\qe

\qb \Delta T_i = \frac{k}{\rho C_p}\frac{2 \Delta t}{B_i} \left[ \frac{T_+-T_i}{B_i\left(1+R \right)} -\frac{T_i-T_-}{\frac{B_i}{R} \left(1+R \right)} \right] \qe 

\qb \Delta T_i = \kappa \frac{2 \Delta t}{ \left( 1+R \right) B^2_i} 
\left[ T_+ -\left( 1+R \right)T_i + RT_-  \right]  \Longleftrightarrow (18s)\qe
 which reduces to (18) if $R=1$ 

\subsubsection{Virtual layers}
 Set heat flow at bottom to zero by setting the under-layer to same temperature as the bottom physical layer.

Set the temperature $T_V$ of the virtual over-layer by requiring that the thermal gradient from its center to center of first physical layer $T_F$ be the same as from surface $T_S$ to that point

\qb \frac{T_S-T_F}{B_F /2} =  \frac{T_V-T_F}{B_V/2 + B_F /2} 
\ \mapsto \  \left(T_S-T_F \right) \frac{B_V + B_F}{B_F}  =T_V-T_F
\ \mapsto \ T_V=T_F - (1+ 1/R) (T_S-T_F)\qe

\subsection{Perturbation} 

Each 'mset'=parr[4] days, perturb temperature at midnight by minus the diurnal average for each layer relative to diurnal average for layer 'Lset'=parr[19]

\subsection{Total depth}
Useful relation for computing depth to bottom of physical layers.
\qb y \equiv \sum_0^n r^k =  \frac{1-r^{n+1}}{1-r} \mc{and}  
  z \equiv \sum_1^n r^k =  \frac{r(1-r^n)}{1-r} \qe
Solve for n:
\qb n_0= \left( \ln \left[ 1+y(r-1) \right]  / \ln r \right) -1 \mc{and} 
n_1=\ln  \left[ \frac{z \left( r-1 \right)}{r} +1 \right] / \ln r \qe

But if $r=1$, the above is degenerate;  \qb n_0=y-1 \mc{and} n_1=z \qe 

For KRC, where first physical layer is $F$=FLAY, $r$=RLAY and the total depth $D$; use $n_0$ with $y=D/F$. Because the first physical layer index is number 2, to ensure total depth $D$ or more, NLAY=ceil($n_0$)+2

IDL routine NUMGEOMLAY is useful for computing number of layers or total depth.

\subsection{Stability and convergence tests}
The safety factor relative to classical convergence, $ B/\sqrt{2 \kappa \Delta t }$,  is constrained to be larger than parr[17], default 0.8 .
 
 
\subsection{Results} 
\subsubsection{Run L} %............................

SIMPLE run L, 20 models listed in Table \ref{srunL}.  Models 16:19 had the same
layer structure: changes were increasing steps/hour and for 19, reducing ggt
1.e-5 to 1.e-8 and reducing the ``last season'' criterion of the maximum change
in midnight temperature of any layer from 1.e-7 to 1.e-10. This last change in
tolerance had negligible effect, $T_S$ at the 48 times of day for Model 18 -
Model 19 had a mean of 1.65e-08 and StdDev of 5.38e-09.

Variation with RLAY and FLAY is shown in Fig \ref{ksclotL18}.  Similar tests with KRC; see Figure \ref{krcCirB}. 
 
KRC case 10 -SIMPLE L:9 has range of -0.19 to +0.16


\begin{table} \caption[SIMPLE parameters]{Parameters of the KRCSIMPLE routine. 
Those marked with '-' do not affect the numerical result; those marked with 'c' were constant 
for this study; primary changes are marked with '+'} \label{sparm}
\begin{verbatim}
-  0    mod.        0.0000  Flag to modify this, +2=only compute depth chart
+  1    nlay        49.000  n1: number of real layers
+  2     n/H        1024.0  n2: times per "hour"
c  3   H/sol        48.000  Output Hours per sol
   4    mset        3.0000  season per reset
   5      n5        20.000  n5: seasons per year
-  6    dBug        0.0000  bit-encoded: +1=stop before return +2=convrgPlot,+4=more plots
-  7   kStop       -2.0000  timestep to stop  ^=^=^=^=^  integer
+  8    flay      0.024000  scaled thickness of first layer
+  9    rlay        1.0620  layer thickness ratio
  10     ggt    1.0000e-05  convergence test
c 11     Alb       0.25000  albedo
c 12    emis        1.0000  emissivity
c 13      TI        200.00  inertia
c 14    dens        1600.0  density
c 15      Cp        647.00  specific heat
- 16    quit        0.0000  - to exit
  17    mSaf       0.80000  minimum safety factor
  18   Tinit        0.0000  starting temperature if positive
  19    Lset        2.0000  physical layer to use for reset INT
  20    delT    1.0000e-07  Season delta T
- 21   etime        41.685  OUT: elapsed time
- 22   depth        6.9906  OUT bottom scaled depth
\end{verbatim}
\vspace{-3.0mm}
\hrulefill \end{table} 


Run L, Model 19 versus 18 shows that tighter tolerances had negligible effect.

\begin{table} \caption [KRCSIMPLE run L models]
{Values for the models in SIMPLE run L.  
Columns with numbers correspond to model parameters in Table \ref{sparm}; 
saFac is the stability safety factor for the top layer. Tdel is the surface
temperature at 7 hours (index 14) relative to the average for all models, to
help in curve identification. Lower part: Difference of surface temperature from
model 18 over the 48 output times; MAR= Mean absolute residual } \label{srunL}
\begin{verbatim}
SIMPLE L
mod.   0     2   4     8      9       10       20        21     22 
  i nlay   n/H mset  flay   rlay       ggt      delT   etime   depth  saFac     Tdel
   0  32    96   2  0.120  1.200  1.00e-05  1.00e-07    8.98  204.49   3.25    0.176
   1  13    96   2  0.120  1.200  1.00e-05  1.00e-07    2.82    5.82   3.25    0.177
   2  19    96   2  0.120  1.100  1.00e-05  1.00e-07    2.88    6.14   3.25    0.132
   3  27    96   2  0.120  1.050  1.00e-05  1.00e-07    3.67    6.56   3.25    0.107
   4  39    96   2  0.120  1.020  1.00e-05  1.00e-07    3.86    6.99   3.25    0.090
   5  46    96   2  0.120  1.010  1.00e-05  1.00e-07    3.92    6.97   3.25    0.085
   6  58    96   2  0.120  1.000  1.00e-05  1.00e-07    4.07    6.96   3.25    0.079
   7  14    96   2  0.100  1.200  1.00e-05  1.00e-07    2.78    5.92   2.71    0.085
   8  21    96   2  0.100  1.100  1.00e-05  1.00e-07    3.61    6.40   2.71    0.044
   9  30    96   2  0.100  1.050  1.00e-05  1.00e-07    3.65    6.64   2.71    0.022
  10  18    96   2  0.050  1.200  1.00e-05  1.00e-07    3.46    6.41   1.35   -0.092
  11  28    96   2  0.050  1.100  1.00e-05  1.00e-07    3.58    6.71   1.35   -0.116
  12  42    96   2  0.050  1.050  1.00e-05  1.00e-07    3.80    6.76   1.35   -0.129
  13  67    96   2  0.050  1.020  1.00e-05  1.00e-07    4.10    6.92   1.35   -0.138
  14 140    96   2  0.050  1.000  1.00e-05  1.00e-07    5.00    7.00   1.35   -0.144
  15  34    96   2  0.050  1.100  1.00e-05  1.00e-07    5.83   12.27   1.35   -0.116
  16  38    96   2  0.050  1.100  1.00e-05  1.00e-07    7.44   18.20   1.35   -0.116
  17  38   192   2  0.050  1.100  1.00e-05  1.00e-07   14.93   18.20   1.91   -0.065
  18  38   384   2  0.050  1.100  1.00e-05  1.00e-07   29.87   18.20   2.71   -0.040
  19  38   384   2  0.050  1.100  1.00e-08  1.00e-10   46.21   18.20   2.71   -0.040

Ts difference from model          18 in K
 model        0      1      2      3      4      5      6      7      8      9
           10     11     12     13     14     15     16     17     18     19
   MAR    0.081  0.081  0.033  0.040  0.045  0.046  0.048  0.061  0.015  0.024
        0.038  0.022  0.035  0.042  0.045  0.022  0.022  0.007  0.000  0.000
  mean   -0.016 -0.016  0.007  0.016  0.020  0.022  0.023 -0.018  0.004  0.012
       -0.020 -0.001  0.005  0.008  0.009 -0.001 -0.001 -0.000  0.000 -0.000
StdDev    0.096  0.096  0.059  0.052  0.051  0.051  0.051  0.066  0.028  0.026
        0.036  0.032  0.043  0.049  0.053  0.032  0.032  0.011  0.000  0.000
\end{verbatim}
\vspace{-3.0mm}
\hrulefill \end{table} 


\begin{table} \caption[KRCsimple runs M and X] {Models parameters for SIMPLE runs M and X. 
Lower part of each: difference of surface temperature from specified model within the run.}  \label{srunM}
\begin{verbatim}
SIMPLE M
  i nlay   n/H mset  flay   rlay       ggt      delT   etime   depth  saFac     Tdel
   0  11   384   2  0.100  1.300  1.00e-05  1.00e-07   14.76    5.64   5.42    0.183
   1  14   384   2  0.050  1.300  1.00e-05  1.00e-07   14.91    6.40   2.71   -0.006
   2  17   384   2  0.025  1.300  1.00e-05  1.00e-07   14.91    7.13   1.35   -0.074
   3  14   384   2  0.100  1.200  1.00e-05  1.00e-07   14.81    5.92   5.42    0.149
   4  18   384   2  0.050  1.200  1.00e-05  1.00e-07   14.97    6.41   2.71   -0.027
   5  22   384   2  0.025  1.200  1.00e-05  1.00e-07   15.12    6.78   1.35   -0.086
   6  21   384   2  0.100  1.100  1.00e-05  1.00e-07   15.16    6.40   5.42    0.109
   7  28   384   2  0.050  1.100  1.00e-05  1.00e-07   15.37    6.71   2.71   -0.051
   8  37   384   2  0.025  1.100  1.00e-05  1.00e-07   19.95    8.25   1.35   -0.099
   9  49   384   2  0.025  1.100  1.00e-05  1.00e-07   41.59   26.43   1.35   -0.099
Ts difference from model           8 
 model        0      1      2      3      4      5      6      7      8      9
   MAR    0.152  0.103  0.085  0.094  0.051  0.036  0.047  0.012  0.000  0.000
  mean   -0.046 -0.044 -0.042 -0.017 -0.018 -0.017  0.005  0.000  0.000 -0.000
StdDev    0.162  0.102  0.082  0.112  0.052  0.035  0.077  0.018  0.000  0.000

SIMPLE X
  i nlay   n/H mset  flay   rlay       ggt      delT   etime   depth  saFac     Tdel
   0  49  1024   3  0.024  1.062  1.00e-05  1.00e-07   41.69    6.99   2.12    0.011
   1  49  2048   3  0.024  1.062  1.00e-05  1.00e-07   83.94    6.99   3.00    0.016
   2  49  4096   3  0.024  1.062  1.00e-05  1.00e-07  165.52    6.99   4.25    0.018
   3  49  8192   3  0.024  1.062  1.00e-05  1.00e-07  333.64    6.99   6.00    0.019
   4  49 16384   3  0.024  1.062  1.00e-05  1.00e-07  672.40    6.99   8.49    0.020
   5  49   512   3  0.024  1.062  1.00e-05  1.00e-07   20.81    6.99   1.50    0.002
   6  49   256   3  0.024  1.062  1.00e-05  1.00e-07   10.26    6.99   1.06   -0.017
   7  49   128   3  0.050  1.062  1.00e-05  1.00e-07   11.32   14.56   1.56   -0.010
   8  49   256   3  0.050  1.062  1.00e-05  1.00e-07   22.66   14.56   2.21    0.028
   9  49    64   3  0.050  1.062  1.00e-05  1.00e-07    5.86   14.56   1.11   -0.086
Ts difference from model           4
 model        0      1      2      3      4      5      6      7      8      9
   MAR    0.003  0.001  0.001  0.000  0.000  0.005  0.011  0.011  0.002  0.033
  mean   -0.000 -0.000 -0.000 -0.000  0.000 -0.000  0.000  0.000  0.001 -0.001
StdDev    0.004  0.002  0.001  0.000  0.000  0.008  0.016  0.016  0.003  0.048
\end{verbatim}
\vspace{-3.0mm}
\hrulefill \end{table} 

Columns in legend for KRCSIMPLOT, e.g., Figure \ref{ksclotL18}: 
\qi 0-based model index
\qi N1 = NLAY = number of layers
\qi n2 = times per "hour" 
\qi flay = scaled thickness of first layer
\qi rlay = layer thickness ratio
\qi D = bottom scaled depth


\begin{figure}[!ht] \igq{ksclotL18}
\caption[Deltas for set L]{ Last-season diurnal temperatures for model set L,
  relative to model L19. Legend linked to Table \ref{sparm}, see text. Models 0:6
  all have flay=0.12 with decreasing RLAY and similar depth; models 7:9 have
  flay=.10 . Models 11:19 (dashed lines) all have flay=0.05, 10:15 with
  decreasing RLAY. Models 15:19 approach an ideal case by first increasing the
  total depth, then the time resolution and finally the convergence
  requirements.
\label{ksclotL18} ksclotL18.png }
\end{figure} 
% how made: gcmcomp@779 callQKRCSIMP

SIMPLE run M had all models with 768 time/Hour and depths about 5:8 D. Variations were only of $F$ and $R$. Reference model has depth of 8.25; increasing to 26 made virtually no difference (MAR= 2.e-6).

\begin{figure}[!ht] \igq{ksclotM8}
\caption[SIMPLE run M]{SIMPLE run M, all with 768 time/hour, relative to model 8.  
\label{ksclotM8}  ksclotM8.png }
\end{figure} 
% how made: 

SIMPLE run X had 9 difference time-steps by factors of 2, all had 49
layers. Models 0:6 used flay=0.024 and lie on a nearly straight line in log time
: log MAR space if the reference is the finest time-step model. Model 7:9 used
flay=0.05 for stability and are twice as deep.  Using KRC extreme-fine model as
reference, models with 1024 to 16384 time-steps per 1/2 hour all had MAR near
0.033 K. The model with flay=.05 and 256 steps per 1/2 hour had the best
performance; MAR= 0.34 K in 22 seconds.  Models with flay=0.024, steps=256 and
flay=0.05, steps=128 were similar with MAR=0.04 and time about 11
sec. Flay=0.05, steps=64 had MAR=.06 in 5.8 sec.

\clearpage

\section{KRC runs and comparisons} %---------------------------------------
Generate idealized geometry matrix with circular orbit and zero obliquity. Use equator ( and $\pm$ 30 and 60 \qd ). After first few runs, generate KRC version 3.2.3 by making these changes:
\qi increase first layer for time doubling to 4 (third physical layer)
\qiii tday8.f, line 171, change J.GT.2 to J.GT.3
\qi set FLAY to be the first physical layer. This is just for convenience of the user.  
\qii Change the default to 0.1 for better accuracy.
\qi Add total depth to printout.
\qi Printout of layers for time doubling: increase the format items
\qi If TDAY(1) detects an error, go to the next case rather than stopping the run.

Did all these changes between Run E and F. Runs:
\qi  1102592 Dec 12 16:16 MarsCirA.t52
\qi 14327552 Dec 19 16:56 MarsCirB.t52
\qi 23144192 Dec 21 18:55 MarsCirC.t52
\qi 14327552 Dec 23 05:22 MarsCirD.t52
\qi 11021312 Dec 23 09:20 MarsCirE.t52
\\ Generate version KRC 3.2.3 with associated changes to FLAY making MarsCirF.t52. Cases (0-based) 0:1 has slightly different input. Cases 2:9 had MAR delta-Ts of 3.e-7, max was 2.e-6
\qi 11021312 Dec 24 10:23 MarsCirF.t52
\qi 12271232 Dec 25 18:05 MarsCirG.t52
\qi 23144192 Dec 26 07:03 MarsCirH.t52
\qi  1339136 Dec 26 21:56 MarsCirX.t52

\begin{figure}[!ht] \igq{krcCirB}
\caption[KRC RLAY tests]{KRC run with circular orbit, zero obliquity and at
  equator; 13 models of different RLAY and FLAY; initial values are 1.2 and
  0.18. N1 mostly set to yield total depth near 7.5 skin depths; exceptions are
  case 0 very deep, 4 about 32, 8 is 23 and 13 is 18. All use N2=4608, or 96
  times each 1/2 hour. Case 10 should be the most accurate.
\label{krcCirB} krcCirB.png }
\end{figure} 
% how made: krcd with MarsCir.inp, then gcmcomp 11 252 22 780

KRC MarsCirC run, starting with case 3 has first physical layer of 0.100 to
match SIMPLE runs. MarsCirC vers L:19; sets differing only in depth at about 6,12 and 16 diurnal
skim depths are virtually the same. 5,11 and 17 have time-steps per
$\frac{1}{2}$ hour of 96, 32 and 16 respectively and RLAY=1.1 . Cases 8,14 and
20 have the same set of time-steps but RLAY=1.2.  Closest match to SIMPLE L:19
is RLAY=1.1 and 32 time steps, see Fig. \ref{krcCirC}.

\begin{figure}[!ht] \igq{krcCirC}
\caption[KRC flay=.1 tests]{KRC run C with flay set so that top physical layer
  is 0.1. Depths of 8,12 and 18 indistinguishable.
\label{krcCirC} krcCirC.png }
\end{figure} 
% how made:

KRC run D. Cases 1:6 have 50 uniform layers of 0.1 to total 4.9 D; cases 7:12
have RLAY=1.2 with first physical layer 0.10, 18 layers to 10.5 D, which
executed 3 times faster. Each set of 6 had standard convergence, then
individually DDT/10, GGT/10, DTMAX/10, add DDT/10, add GGT/10. Virtually no
difference between the 6 cases of either set, see Fig. \ref{krcCirD}. The last
case has CONVF increased from 2 to 32, moving first time doubling from 2 to 7
and increasing run time by 27\%. Relative to SIMPLE L:19, first 6 range -0.13 K
(dusk) to +0.13 (after sunrise); second 6 -0.55 (dawn) to +0.35 (noon). Last
case similar to first six, suggesting that KRC standard CONVG is too small.

\begin{figure}[!ht] \igq{krcCirD}
\caption[KRC flay=.1 tests]{KRC run D relative to SIMPLE L:19; variation with changes of DDT, GGT and DTMAX are indistinguishable as only the last curve of sets 0:5 and 6:11 are visible. Setting CONVFG high, which lessens the time doubling, has an effect.
\label{krcCirD} krcCirD.png }
\end{figure} 
% how made:

\clearpage

KRC run E.  All with 18432 time-steps/sol, or 384 each 1/2 hour, and depths of
about 7. Matrix of RLAY=1.3, 1.2, 1.1 and first physical layer of 0.1, 0.05, and
0.025.  Preceded by one case with NLAY=50, rlay=1.1 . First 4 cases started
time doubling at layer 2, then layer 4 or more. Results relative to SIMPLE L19
shown in Fig. \ref{krcCirE}; all relative maxima are in the morning and
minima at night.  Larger RLAY move relative maximum later in the day and
increases value by about 0.1 K. Larger FLAY increases Tmax by 0.,.05,.15 .

For first physical layer 0.025, rlay=1.1, depth of 8.2, n/h of 384, first
time-doubling layer or 13, KRC -SIMPLE has MAR of 0.017 K, mean diff is -.009 K
with StdDev=0.017 K.

For KRC with RLAY=1.2 and topLay=0.1, MAR=0.154, mean =-0.059, StdDev=0.156; so
this is adequate for 0.2K accuracy.

\begin{figure}[!ht] \igq{krcCirE}
\caption[KRC flay=.1 tests]{KRC run E relative to SIMPLE L:18; all with N2=18432 or 384 per 1/2 hour, CONVF=8., RLAY=1.1, FLAY= 0.0769. Matrix of RLAY=1.3, 1.2, 1.1 and first physical layer of 0.1, 0.05, and 0.025. 
\label{krcCirE} krcCirE.png }
\end{figure} 
% how made:

KRC run F. Apart from adjusting FLAY to the new convention, same input as run E.  First case (0) differs because of flay, cases 1:3  have lower limit of time-doubling starting with 3.  
Cases 4:9 differences from Run E are less than 7.5e-7 K. See Fig. \ref{krcCirF}

\begin{figure}[!ht] \igq{krcCirF}
\caption[KRC flay/RLAY tests]{KRC run E relative to SIMPLE M:8; all with N2=18432 or 384 per 1/2 hour, CONVF=8., Matrix of RLAY=1.3, 1.2, 1.1 and first physical layer of 0.1, 0.05, and 0.025. 
\label{krcCirF} krcCirF.png }
\end{figure} 
% how made:

\clearpage
Run G, several sets of 10 cases, first for each is NLAY=20 (very first is 50),
then then 3x3 matrix of flay and RLAY. Set 1 is N2=24576 (512 per 1/2hour),
convg=8; then 256, convg=4; then 128, convg=2; then 64, convg=1, then 31 and
then 16 per 1/2hour

Run H, similar to G, with some additional fine cases; results shown in Fig. \ref{marHI} and  \ref{marHJ}. Making the convergence requirement about 3 significantly improves accuracy with little increase in run-time.

\begin{figure}[!ht] \igq{marHI}
\caption[Accuracy versus time]{Abscissa: execution time for one latitude in
  seconds. Ordinate: accuracy for cases in Table \ref{runH} as the MAR relative to case 3 in run X, which is at KRC limits for resolution; shown in white.  In each of the 6 groups with similar run times, RLAY decreases most rapidly with index, then FLAY. The dotted line indicates MAR=0.1/time in K/s . Shown in red are the results for Run I, which corresponds to H:27 except for NLAY and CONVG. 
\label{marHI} marHI.png }
\end{figure} 
% how made: gcmcomp[ 130 123, then 11 for 2nd file, 252,22,782

\begin{figure}[!ht] \igq{marHJ}
\caption[Accuracy versus shorter time]{ Similar to Fig. \ref{marHI} but with results of Run J in red.
\label{marHJ} marHJ.png }
\end{figure} 
% how made: gcmcomp[ 130 123, then 11 for 2nd file, 252,22,782

\begin{table} \caption[KRC run H]{Summary results for KRC run on MarsCirH.inp . 
Columns are: i= 0-based case index; RLAY= layer thickness geometric ratio; FLAY=
top physical layer in diurnal skin depths; CVG= convergence safety factor; NLAY=
number of layers, including the virtual; Ntime= time-steps per sol; Deep= scaled
depth to the bottom of physical layers; Scong= Convergence safety factor for top
physical layer; secs= execution time in seconds for one latitude; MAR= Mean
Absolute Residual in K relative to case 0; Tdel= difference in K at 7 Hours
relative to case 0.}
% Last partial column in time-steps per Hour (1/24 of a sol)} 
\label{runH}
\begin{verbatim}
 i  RLAY   FLAY    CVG NLAY  Ntime    Deep  Sconv   secs    MAR   Tdel
 0 1.062  0.024   8.00   50  98304    6.99   9.01  14.22  0.000   0.00
 1 1.062  0.024   8.00   50  49152    6.99   4.51   8.56  0.012  -0.02
 2 1.100  0.025   8.00   37  98304    7.48   9.78  12.12  0.026   0.01
 3 1.100  0.025   8.00   37  49152    7.48   4.89   7.00  0.016  -0.02
 4 1.300  0.100   8.00   13  49152    7.43  78.22   5.14  0.146   0.28
 5 1.200  0.100   8.00   16  49152    7.20  78.22   5.14  0.087   0.22
 6 1.100  0.100   8.00   23  49152    7.14  78.22   5.20  0.055   0.18
 7 1.300  0.050   8.00   16  49152    8.36  19.56   5.14  0.145   0.03
 8 1.200  0.050   8.00   20  49152    7.74  19.56   5.19  0.099   0.05
 9 1.100  0.050   8.00   30  49152    7.43  19.56   5.48  0.042   0.06
10 1.300  0.025   8.00   18  49152    7.13   4.89   5.42  0.172   0.00
11 1.200  0.025   8.00   24  49152    8.16   4.89   5.86  0.089  -0.02
12 1.100  0.025   8.00   37  49152    7.48   4.89   6.99  0.016  -0.02
13 1.300  0.100   4.00   13  12288    7.43  19.56   1.30  0.158   0.21
14 1.200  0.100   4.00   16  12288    7.20  19.56   1.30  0.122   0.12
15 1.100  0.100   4.00   23  12288    7.14  19.56   1.33  0.092   0.12
16 1.300  0.050   4.00   16  12288    8.36   4.89   1.30  0.283  -0.02
17 1.200  0.050   4.00   20  12288    7.74   4.89   1.36  0.155  -0.02
18 1.100  0.050   4.00   30  12288    7.43   4.89   1.53  0.064  -0.00
19 1.300  0.025   4.00   18  12288    7.13   1.22   1.44  0.253  -0.10
20 1.200  0.025   4.00   24  12288    8.16   1.22   1.59  0.141  -0.13
21 1.100  0.025   4.00   37  12288    7.48   1.22   1.97  0.037  -0.08
22 1.300  0.100   2.00   13   6144    7.43   9.78   0.66  0.181   0.12
23 1.200  0.100   2.00   16   6144    7.20   9.78   0.66  0.186  -0.03
24 1.100  0.100   2.00   23   6144    7.14   9.78   0.68  0.170   0.00
25 1.300  0.050   2.00   16   6144    8.36   2.44   0.67  0.507  -0.17
26 1.200  0.050   2.00   20   6144    7.74   2.44   0.69  0.294  -0.13
27 1.100  0.050   2.00   30   6144    7.43   2.44   0.78  0.147  -0.08
28 1.300  0.100   1.00   13   3072    7.43   4.89   0.35  0.249  -0.07
29 1.200  0.100   1.00   16   3072    7.20   4.89   0.35  0.369  -0.37
30 1.100  0.100   1.00   23   3072    7.14   4.89   0.36  0.377  -0.25
31 1.300  0.050   1.00   16   3072    8.36   1.22   0.35  1.056  -0.53
32 1.200  0.050   1.00   20   3072    7.74   1.22   0.36  0.631  -0.39
33 1.100  0.050   1.00   30   3072    7.43   1.22   0.41  0.346  -0.25
34 1.300  0.100   1.00   13   1536    7.43   2.44   0.18  0.448  -0.49
35 1.200  0.100   1.00   16   1536    7.20   2.44   0.18  0.552  -0.51
36 1.100  0.100   1.00   23   1536    7.14   2.44   0.19  0.415  -0.26
37 1.300  0.100   1.00   13    768    7.43   1.22   0.10  1.016  -1.19
38 1.200  0.100   1.00   16    768    7.20   1.22   0.10  0.540  -0.68
39 1.100  0.100   1.00   23    768    7.14   1.22   0.11  0.324  -0.65
\end{verbatim}
\vspace{-3.0mm}
\hrulefill \end{table} 

Run I: all with RLAY=1.1, FLAY=0.05 and N2=6144.; set of decreasing number of layers from 30 to 22. Three sets, with CONVG 2,4 and 8; if adequately deep (D=5.), MAR is .140, .042, and  0.029 respectively. Increase in error less than factor of 2 if NLAY=24 or more; D=3.98 .  


Run J: same style as I, but FLAY=0.1 and N2=1536, then 768; NLAY 21 to 18.
All 768 had MAR 0.15 or more. with N2=1536, if CONVG 3 or more, MAR about 0.07; NLAY=20 (D=5.12) was optimum.


\begin{table} \caption[KRC runs E, F, I]{KRC runs E, F, I. See Table \ref{runH} caption}   \label{runE}
\begin{verbatim}
 i  RLAY   FLAY    CVG NLAY  Ntime    Deep  Sconv   secs    MAR   Tdel
E:9
 0 1.100  0.077   8.00   50  18432   81.32  17.36  10.15  0.076   0.18
 1 1.300  0.091   8.00   12  18432    5.13  24.24   9.26  0.199   0.36
 2 1.200  0.083   8.00   15  18432    4.93  20.37   9.35  0.147   0.24
 3 1.100  0.091   8.00   18  18432    3.69  24.24   9.73  0.083   0.21
 4 1.300  0.038   8.00   15  18432    4.92   4.34   9.77  0.185   0.09
 5 1.200  0.042   8.00   19  18432    5.34   5.09  10.43  0.102   0.05
 6 1.100  0.045   8.00   23  18432    3.25   6.06  12.02  0.045   0.02
 7 1.300  0.019   8.00   22  18432   15.77   1.08  11.11  0.144  -0.02
 8 1.200  0.021   8.00   29  18432   17.07   1.27  11.96  0.079  -0.01
 9 1.100  0.023   8.00   38  18432    7.50   1.52  15.55  0.000   0.00
F:9
 i  RLAY   FLAY    CVG NLAY  Ntime    Deep  Sconv   secs    MAR   Tdel
 0 1.100  0.100   8.00   50  18432  105.72  29.33  10.38  0.074   0.20
 1 1.300  0.100   8.00   12  18432    5.64  29.33   9.91  0.162   0.27
 2 1.200  0.100   8.00   15  18432    5.92  29.33   9.94  0.120   0.20
 3 1.100  0.100   8.00   18  18432    4.05  29.33  10.24  0.070   0.18
 4 1.300  0.050   8.00   15  18432    6.40   7.33  10.03  0.185   0.09
 5 1.200  0.050   8.00   19  18432    6.41   7.33  10.70  0.102   0.05
 6 1.100  0.050   8.00   23  18432    3.57   7.33  12.29  0.045   0.02
 7 1.300  0.025   8.00   22  18432   20.51   1.83  11.37  0.144  -0.02
 8 1.200  0.025   8.00   29  18432   20.48   1.83  12.23  0.079  -0.01
 9 1.100  0.025   8.00   38  18432    8.25   1.83  15.81  0.000   0.00

I rel X:3
 i  RLAY   FLAY    CVG NLAY  Ntime    Deep  Sconv   secs    MAR   Tdel
 0 1.100  0.050   2.00   50   6144   52.86   2.44   0.79  0.140  -0.10
 1 1.100  0.050   2.00   30   6144    7.43   2.44   0.78  0.140  -0.10
 2 1.100  0.050   2.00   28   6144    6.06   2.44   0.78  0.140  -0.10
 3 1.100  0.050   2.00   26   6144    4.92   2.44   0.78  0.138  -0.10
 4 1.100  0.050   2.00   24   6144    3.98   2.44   0.78  0.145  -0.13
 5 1.100  0.050   2.00   22   6144    3.20   2.44   0.77  0.201  -0.08
 6 1.100  0.050   2.00   20   6144    2.56   2.44   0.77  0.256   0.31
 7 1.100  0.050   4.00   30   6144    7.43   2.44   0.90  0.043  -0.09
 8 1.100  0.050   4.00   28   6144    6.06   2.44   0.90  0.043  -0.09
 9 1.100  0.050   4.00   26   6144    4.92   2.44   0.89  0.041  -0.09
10 1.100  0.050   4.00   24   6144    3.98   2.44   0.89  0.053  -0.12
11 1.100  0.050   4.00   22   6144    3.20   2.44   0.89  0.091  -0.08
12 1.100  0.050   4.00   20   6144    2.56   2.44   0.88  0.196   0.30
13 1.100  0.050   8.00   30   6144    7.43   2.44   1.00  0.029  -0.05
14 1.100  0.050   8.00   28   6144    6.06   2.44   1.00  0.029  -0.05
15 1.100  0.050   8.00   26   6144    4.92   2.44   0.99  0.030  -0.05
16 1.100  0.050   8.00   24   6144    3.98   2.44   0.99  0.037  -0.07
17 1.100  0.050   8.00   22   6144    3.20   2.44   0.98  0.053  -0.03
18 1.100  0.050   8.00   20   6144    2.56   2.44   0.97  0.196   0.34
\end{verbatim}
\vspace{-3.0mm}
\hrulefill \end{table}  

\begin{table} \caption[KRC run G]{KRC run G. See Table \ref{runH} caption}  \label{runG}
\begin{verbatim}
G:9
 i  RLAY   FLAY    CVG NLAY  Ntime    Deep  Sconv   secs    MAR   Tdel
 0 1.050  0.090   8.00   50  24576   17.86  31.68   2.90  0.042   0.17
 1 1.300  0.100   8.00   13  24576    7.43  39.11   2.58  0.152   0.28
 2 1.200  0.100   8.00   16  24576    7.20  39.11   2.59  0.104   0.22
 3 1.100  0.100   8.00   23  24576    7.14  39.11   2.64  0.066   0.20
 4 1.300  0.050   8.00   16  24576    8.36   9.78   2.59  0.180   0.08
 5 1.200  0.050   8.00   20  24576    7.74   9.78   2.69  0.092   0.07
 6 1.100  0.050   8.00   30  24576    7.43   9.78   3.03  0.031   0.06
 7 1.300  0.025   8.00   18  24576    7.13   2.44   2.87  0.155   0.00
 8 1.200  0.025   8.00   24  24576    8.16   2.44   3.18  0.073  -0.02
 9 1.100  0.025   8.00   37  24576    7.48   2.44   3.93  0.000   0.00
10 1.300  0.100   4.00   13  12288    7.43  19.56   1.30  0.160   0.24
11 1.200  0.100   4.00   16  12288    7.20  19.56   1.30  0.123   0.15
12 1.100  0.100   4.00   23  12288    7.14  19.56   1.33  0.094   0.15
13 1.300  0.050   4.00   16  12288    8.36   4.89   1.30  0.280   0.01
14 1.200  0.050   4.00   20  12288    7.74   4.89   1.35  0.152   0.01
15 1.100  0.050   4.00   30  12288    7.43   4.89   1.52  0.062   0.02
16 1.300  0.025   4.00   18  12288    7.13   1.22   1.44  0.249  -0.07
17 1.200  0.025   4.00   24  12288    8.16   1.22   1.60  0.135  -0.10
18 1.100  0.025   4.00   37  12288    7.48   1.22   1.98  0.026  -0.05
19 1.300  0.100   2.00   13   6144    7.43   9.78   0.66  0.181   0.15
20 1.200  0.100   2.00   16   6144    7.20   9.78   0.66  0.182  -0.00
21 1.100  0.100   2.00   23   6144    7.14   9.78   0.68  0.169   0.03
22 1.300  0.050   2.00   16   6144    8.36   2.44   0.67  0.504  -0.14
23 1.200  0.050   2.00   20   6144    7.74   2.44   0.69  0.290  -0.10
24 1.100  0.050   2.00   30   6144    7.43   2.44   0.78  0.142  -0.05
25 1.300  0.100   1.00   13   3072    7.43   4.89   0.35  0.246  -0.05
26 1.200  0.100   1.00   16   3072    7.20   4.89   0.35  0.361  -0.34
27 1.100  0.100   1.00   23   3072    7.14   4.89   0.36  0.372  -0.22
28 1.300  0.050   1.00   16   3072    8.36   1.22   0.35  1.052  -0.50
29 1.200  0.050   1.00   20   3072    7.74   1.22   0.36  0.625  -0.36
30 1.100  0.050   1.00   30   3072    7.43   1.22   0.41  0.340  -0.22
31 1.300  0.100   1.00   13   1536    7.43   2.44   0.18  0.441  -0.46
32 1.200  0.100   1.00   16   1536    7.20   2.44   0.18  0.545  -0.48
33 1.100  0.100   1.00   23   1536    7.14   2.44   0.19  0.409  -0.24
34 1.300  0.100   1.00   13    786    7.43   1.25   0.12  0.323   0.12
35 1.200  0.100   1.00   16    786    7.20   1.25   0.12  0.311   0.13
36 1.100  0.100   1.00   23    786    7.14   1.25   0.14  0.258  -0.07
\end{verbatim}
\vspace{-3.0mm}
\hrulefill \end{table}  

\begin{table} \caption[KRC runs J and X]{KRC runs J and X. See Table \ref{runH} caption}  \label{runJ}
\begin{verbatim}
J rel X:3
 i  RLAY   FLAY    CVG NLAY  Ntime    Deep  Sconv   secs    MAR   Tdel
 0 1.100  0.100   2.00   22   1536    6.40   2.44   0.21  0.122  -0.21
 1 1.100  0.100   2.00   21   1536    5.73   2.44   0.21  0.122  -0.21
 2 1.100  0.100   2.00   20   1536    5.12   2.44   0.21  0.121  -0.21
 3 1.100  0.100   2.00   19   1536    4.56   2.44   0.21  0.120  -0.22
 4 1.100  0.100   2.00   18   1536    4.05   2.44   0.21  0.128  -0.23
 5 1.100  0.100   3.00   21   1536    5.73   2.44   0.22  0.072  -0.18
 6 1.100  0.100   3.00   20   1536    5.12   2.44   0.23  0.072  -0.18
 7 1.100  0.100   3.00   19   1536    4.56   2.44   0.22  0.073  -0.18
 8 1.100  0.100   3.00   18   1536    4.05   2.44   0.22  0.083  -0.20
 9 1.100  0.100   4.00   21   1536    5.73   2.44   0.24  0.067  -0.14
10 1.100  0.100   4.00   20   1536    5.12   2.44   0.24  0.068  -0.14
11 1.100  0.100   4.00   19   1536    4.56   2.44   0.24  0.071  -0.14
12 1.100  0.100   4.00   18   1536    4.05   2.44   0.23  0.077  -0.16
13 1.100  0.100   6.00   21   1536    5.73   2.44   0.25  0.066  -0.10
14 1.100  0.100   6.00   20   1536    5.12   2.44   0.25  0.067  -0.10
15 1.100  0.100   6.00   19   1536    4.56   2.44   0.25  0.070  -0.11
16 1.100  0.100   6.00   18   1536    4.05   2.44   0.25  0.070  -0.13
17 1.100  0.100   2.00   21    768    5.73   1.22   0.13  0.171  -0.48
18 1.100  0.100   2.00   20    768    5.12   1.22   0.13  0.171  -0.48
19 1.100  0.100   2.00   19    768    4.56   1.22   0.13  0.174  -0.49
20 1.100  0.100   2.00   18    768    4.05   1.22   0.13  0.182  -0.51
21 1.100  0.100   3.00   21    768    5.73   1.22   0.13  0.158  -0.42
22 1.100  0.100   3.00   20    768    5.12   1.22   0.13  0.159  -0.42
23 1.100  0.100   3.00   19    768    4.56   1.22   0.13  0.162  -0.42
24 1.100  0.100   3.00   18    768    4.05   1.22   0.13  0.163  -0.44
25 1.100  0.100   4.00   21    768    5.73   1.22   0.14  0.153  -0.40
26 1.100  0.100   4.00   20    768    5.12   1.22   0.14  0.154  -0.40
27 1.100  0.100   4.00   19    768    4.56   1.22   0.14  0.157  -0.41
28 1.100  0.100   4.00   18    768    4.05   1.22   0.14  0.158  -0.43
29 1.100  0.100   6.00   21    768    5.73   1.22   0.15  0.148  -0.40
30 1.100  0.100   6.00   20    768    5.12   1.22   0.14  0.149  -0.40
31 1.100  0.100   6.00   19    768    4.56   1.22   0.14  0.152  -0.40
32 1.100  0.100   6.00   18    768    4.05   1.22   0.14  0.152  -0.42

X:3 
 i  RLAY   FLAY    CVG NLAY  Ntime    Deep  Sconv   secs    MAR   Tdel
 0 1.062  0.024   8.00   50  98304    6.99   9.01  14.24  0.011  -0.02
 1 1.062  0.024   8.00   50  49152    6.99   4.51   8.56  0.023  -0.04
 2 1.062  0.024   8.00   50 196608    6.99  18.02  24.03  0.003  -0.00
 3 1.062  0.024   8.00   50 393216    6.99  36.04  44.22  0.000   0.00
 4 1.100  0.025   8.00   37  49152    7.48   4.89   7.00  0.014  -0.04
 5 1.100  0.025   8.00   40  49152   10.04   4.89   7.00  0.014  -0.04
\end{verbatim}
\vspace{-3.0mm}
\hrulefill \end{table}  


Newton iterations on surface power balance continue until the change in $T_S$ is less than GGT.

DTM is the RMS of change in layer temperatures at midnight: $=\sqrt{ \sum_1^{N1} \Delta T_\mathrm{midnight} } / N1 $

If DTM is less than DTMAX or if the fractional change in DTM over the prior day is less than DDT, the next day will be the last for the current season, unless DTM then increases or becomes greater than DTMAX. 

Convergence results stored in .t52 files ares:
 \qi NDJ4, the number of days computed in each season, for each latitude
\qi DTM4, DTM for each latitude

Run V:  2048  per hour, RLAY=1.062, FLAY=0.024, 50 layers and CONVF=8, with each of GGT, DDT, and DTMAX set to twice, 1/2 and 1/5 their normal values; MAR 1.e-13 at most. Setting CONVG=2 yielded MAR=0.11 .

For run V,  all DTM4 are 0 and all NDJ4 are 3.

Run V2 only decreased GGT by a factor of 10 between cases, covering 1.e-2 to 1.e-5. MAR, relative to the last, is  2.9e-07,   8.5e-10,   4.5e-14 and 0. Run times for the first two were 7 and 2\% less than the last.  All DTM4 are 0 and all NDJ4 are 3.


\subsubsection{Long runs} %.....................................

KRC run X; MarsCirX.inp, all 2048/hour up to 16384/hour.
\qi To obtain 0.01 K accuracy takes about 15 seconds  

The succession of increasing the number of time steps by a factor of 2 shown in
Fig. \ref{g781X3} suggests that the finest used, case 3, is within 0.002 K of
limit.  A corollary is that with 2048 times per hour, Case 1, the MAD from the
limit is about .025 K.  Case 4 and 5, which differ only in depth, has a mean
absolute difference (MAD) of 1.e-5 K . Case 1 (blue) and 4 (purple) are similar
except to RLAY being 1.062 and 1.1 and have a MAD of .025 K.

\begin{figure}[!ht] \igq{g781X3}
\caption[KRC relative to SIMPLE:6]{ KRC MarsCir run X surface temperatures relatives to SIMPLE run X case 6 ??MORE 
\label{g781X3} g781X3.png  }
\end{figure} 
% how made: 


SIMPLE  X.sav: layer to match KRC X, with n per 1/2 hour of  256 to 16384,
and 64 to 256 with flay=0.05

Largest difference in cases in common with KRC X is 0.008 K 

For 2048 to 16384 per 1/2 hour, KRC is about 10 times faster than SIMPLE
with mset=3.

\begin{table} \caption[Long runs]{KRC run x} \label{runX}
\begin{verbatim}
---
\end{verbatim}
\vspace{-3.0mm}
\hrulefill \end{table} 

\begin{figure}[!ht] \igq{ksclotX4}
\caption[SIMPLE with small timesteps]{SIMPLE run X, matching the finest
  time-steps of KRC. All models have 49 physical layers, corresponding to
  maximum of KRC, a total depth of 6.99 D, and RLAY=1.06, matching KRC run
  X. Models 0 to 6 have time steps of 512 to 32768 per Hour. Models 8:9 have
  flay=0.05 (and are deeper, which matters little).
\label{ksclotX4} ksclotX4.png }
\end{figure} 
% how made: 

Direct comparison of KRC and SIMPLE, both run with small timesteps and layers,
is shown in Figure \ref{ksclotXmKRCX3}. It is clear that the limit of finer
time-steps in SIMPLE would have a MAR close to the 0.032 K; the shape looks like
KRC has slightly lower thermal inertia.



\begin{figure}[!ht] \igq{ksclotXmKRCX3}
\caption[SIMPLE-KRC]{SIMPLE run X relative to KRC run X case 3 (N2=max
  allowed). Model 4 (red) had the same conditions as case 3 but MAR is .032; shape
  looks like KRC has slightly lower thermal inertia.
\label{ksclotXmKRCX3} ksclotXmKRCX3.png }
\end{figure} 
% how made: 
\clearpage

\input{slab} %<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<

\section{KRC runs with real eccentricity and obliquity}
File names: input=\nf{Mars3.inp}, print=\nf{MarsA.prt}, and binary files =\nf{MarsA.pt52} and higher letters.

Real Mars geometry matrix, 40 season/year, N2=1536, CONVF=3. FLAY=0.1, RLAY=1.1,
 first case has N1=50. Spin-up for 2 years and run for 8 more, start disk save after the first year.  

Run A: as above

Run B:  RLAY=1.125 to get deeper. N1 from 50 to 18 by 2's. Case 0 has bottom of  256.0 . Layer Tmin and Tmax stored only to number of hours (48) -2, so Case 2 with 46 layers and D=159.5 is the first for which the bottom layer is stored in the .t52 file; for this maximum range of the lowest layer is $\Delta T$=0.004 K
\vspace{-3.mm} 
\begin{verbatim}
 yy=NUMGEOMLAY(46,flay=[.1,.07,.05],rlay=[1.1,1.11,1.12,1.125, 1.13, 1.14, 1.15]) 
ratio          NUMGEOMLAY: NLAY=       46
 first=  0.1000 0.0700 0.0500
1.1000    79.18  55.43  39.59
1.1100   109.62  76.73  54.81
1.1200   152.22 106.56  76.11
1.1250   179.55 125.68  89.77
1.1300   211.88 148.32 105.94
1.1400   295.42 206.80 147.71
1.1500   412.39 288.67 206.19
\end{verbatim} 

Run C: Similar to run B but record all seasons. RLAY=1.14  Range in execution time is small, and many cases increase in time with less accuracy (difference from deepest model) !

Run D: Extend N5 to 640, 16 years. All N1 from 45 to 36, then even values to 28.
\\  KOMMON,KASE=  10000000  649152  \ RASE,MASE,MTOT=   15.404713    15     9737280


\subsection{Extreme case: 60\qd S with no atmosphere}

 Several characteristics are shown in Figures  \ref{tm644s}, \ref{tm644l}, \ref{tm644a}, \ref{tm644h} and \ref{tm644y}.

\begin{figure}[!ht] \igq{tm644h}
\caption[60S no atm., diurnal surface temperature]{KRC run D, 60S no atm.,
  diurnal surface temperature for each season of the last year.
\label{tm644h}  tm644h.png }
\end{figure} 
% how made: tthmod

\begin{figure}[!ht] \igq{tm644s}
\caption[60S no atm., Seasonal T vers depth ]{KRC run D, 60S no atm., Seasonal
  variation of the diurnal mean versus depth. Abscissa is physical layer 0-based
  index. Legend indicates season index.
\label{tm644s} tm644s.png  }
\end{figure} 
% how made: tthmod

\begin{figure}[!ht] \igq{tm644l}
\caption[60S no atm., Layer diurnal mean versus season ]{KRC run D, 60S no atm.,
  Layer diurnal mean versus season.  Legend indicates 1-based physical layer.
\label{tm644l} tm644l.png  }
\end{figure} 
% how made: tthmod


\begin{figure}[!ht] \igq{tm644a}
\caption[60S no atm., successive years ]{KRC run D, 60S no atm. showing average
  annual temperature versus depth for successive years. Year 0 is at the end of
  the first season, all others are at the end of the year. Abscissa is physical
  layer 0-based index.
\label{tm644a} tm644a.png  }
\end{figure} 
% how made:

\begin{figure}[!ht] \igq{tm644y}
\caption[60S no atm., successive years ]{KRC run D, 60S no atm. showing average
  annual temperature versus time for each layer.  Year 0 is at the end of the
  first season, all others are at the last season of the year. Layers shallower
  than about 25 show little variation after two years.
\label{tm644y} tm644y.png  }
\end{figure} 
% how made:


For runs of 8 years, the annual and secular variation of the diurnal mean
temperature are comparable at about 0.7K for total depths of about 154 D. To get
to 0.2 K, need model depth of about 200 D and runs of 16 years.; see Fig
 \ref{tm640D2bot}.

\begin{figure}[!ht] \igq{tm640D2bot}
\caption[KRC run D 60S bottom layers]{Diurnal mean temperature for the bottom
  layer for KRC run D 60S.  The legend indicates the case index, the number of
  layers (physical +1) and the model total thickness in diurnal skin-depths.
\label{tm640D2bot} tm640D2bot.png  }
\end{figure} 
% how made: 

The average annual temperature for the surface is within 0.1K by the end of year 2; see Fig \ref{tm643taD} 

\begin{figure}[!ht] \igq{tm643taD}
\caption[Run D bottom]{Annual average surface temperatures for each year and
  latitude relative to those for the last year of the run for Case 0 (very deep)
\label{tm643taD}  tm643taD.png }
\end{figure} 
% how made:

 The results for annual average are more regular than for using the last season
 of each year, Fig. \ref{tm643baD}. The model with total thickness 117 D have
 converged to within about 0.

\begin{figure}[!ht] \igq{tm64bD0}
\caption[Run D surface]{ Diurnal average surface temperatures at the equator for
  each year relative to those over the last year of the run. The legend
  indicates the case index, the number of layers (physical +1) and the model
  total thickness in diurnal skin-depths.
\label{tm64bD0}  tm64bD0.png }
\end{figure} 
% how made:

Looking at the diurnal mean of the bottom layer for cases of different total
depth for a situation with extreme seasonal variation, Fig. \ref{tm640D2bot},
secular trends are less than about 0.1k in 7 years for total depth of 101D, 10
years for 117D , and 13 years for 134D.


\begin{figure}[!ht] \igq{tm643baD}
\caption[Run D bottom]{Annual average bottom temperatures for each year and
  latitude relative to those for the last year of the run for Case 0 (very deep)
\label{tm643baD}  tm643baD.png }
\end{figure} 
% how made:

\begin{figure}[!ht] \igq{g785C2}
\caption[bottom secular trend]{Average diurnal temperature ((min+max)/2) of the
  lowest layers through all seasons and years. The annual oscillation magnitude
  is similar to the secular trend over years 5 to 10 (arbitrary) for a case with
  about 39 layers
\label{g785C2} g785C2.png }
\end{figure} 
% how made: kv3: 785

The seasonal variation of the mean diurnal temperature for the same depth is little effected by having additional deeper layers, see Fig. \ref{tm640D2L40}, although convergence is slowed.

\begin{figure}[!ht] \igq{tm640D2L40}
\caption[Seasonal variation at a fixed depth]{Seasonal variation of layer 40, 145 D, for 60S; this is the bottom layer for case 6 [orange]. Annual oscillation is slightly attenuated by having one additional layer, case 5 [purple] but little more with deeper layers. Bottom layer amplitude increases a factor of about 2 if there is one less total layer [gray]; however the annual average has nearly converged in 16 years for case 7. 
\label{tm640D2L40}  tm640D2L40.png }
\end{figure} 
% how made: 
=
\begin{figure}[!ht] \igq{tm645aD}
\caption[MAR versus case]{MAR of the Surface temperature (all hours, all seasons) in the last year relative to those of the last year of case 0 (very deep).
\label{tm645aD} tm645aD.png  }
\end{figure} 
% how made: 


Comparing Ts each year with that of the last year for each hour,lat,season of reference case 0, see that the major departures are related to different number of convergence days NDJ4.
 The time of day of maximum difference is not consistent, but can form the MAR over hours, and then over season, showing that surface temperature errors can be under 0.05K by using total depth of at least 100D and 3 years (spin-up of 2 years), see Figure \ref{tm645yD}.

\begin{figure}[!ht] \igq{tm645yD}
\caption[ Surface temperature MAR]{MAR of the surface temperature over hour and season for each year of KRC run D, relative to these temperatures for last year of case 0 (very deep). The year-to-year oscillation at the .005 K level are related to differences in the number of integration days NDJ4.  
\label{tm645yD}  tm645yD.png }
\end{figure} 
% how made: 


\clearpage

\section{Accuracy estimates for Real bodies: start of a plan}

Objective is to estimate numerical errors for real bodies and to develop recommendations for convergence parameters. 

Primarily for surface temperatures, but include results for the bottom layer

With atmosphere for Mars. Without atm. for some eccentric-orbit asteroid
\qi Run both skip and soly versions
\qi  homogeneous and layered
\qi  with and without temperature dependence
\qi A few inertia's
\qi Shallow and deep that bracket practical annual cases
\qi minimum and large annual variation (latitudes of 0,-30,-60 )
\qi ? a case that ignores annual wave?
\qi Practical results would be N2=384 *[1,4,?]

Runs: 
\qi    Mars: latitudes 0,-30,-45.  Asteroid: 0,30,60,-30, -60
\qi   skip / soly 
\qii  soly runs can only have one latitude unless only a few years
\qi  N2= 384, 768,1536, 12288 ; large for only the base case
\qii Total depth: [7, 25,]130 D
\qi Cases: 
\qii  Homogeneous inertia's: I=50, 200 (base case), 1800
\qii  Two materials: 50 over 1800, IC=small and large

\section{J. Spencer model}
John Spencer made public a thermal model described in:  
A Rough-Surface Thermophysical Model for Airless Planets, Icarus, v. 83, ppp27-38, (1990). 

 Download tar from https://www.boulder.swri.edu/$\sim$spencer/thermprojrs/ into
/home/hkieffer/krc/Spencer/thermprojrs/ . Copy the *.pro into -/idl/other/ so that IDL can find them. Look at \nf{readme.txt} Then do:
\\ thermprojrs,tsurf,tod,rhel=1.523712,alb=0.2,rot=1.0,emvty=1.,ti=2.e5,ntinc=6144
\qi to get 128 time steps for each of 48 ``hours''.
\vspace{-3.mm} 
\begin{verbatim} 
Albedo= 0.20,  Upper layer TI=  2.00e+05,  Heat flow=  0.00e+00erg cm-2 s-1
Thermal conductivity=  2.67e+03 erg cm-1 s-1 K-1
Skindepth for upper layer =   1.564 cm
Theta=  1.089
Input C/R to continue : 
Equilibrium temperatures: Peak=  302.29,  Dark=    0.00
Maximum conductive stability criterion=   0.050
Maximum Radiative stability criterion =   0.009

Energy Conservation Report at end of each run:
        Mean       Mean      Total  Net Power  Mean
      Power In   Power Out  Energy     Out     Surf.  Deep
 Run    W m-2      W m-2    In/Out    W m-2    Temp.  Temp.
-----------------------------------------------------------
   0  1.507e+02  1.507e+02  0.9999 -7.836e-03 214.00 213.75
   1  1.507e+02  1.507e+02  1.0000  3.487e-04 214.01 213.79
\end{verbatim} 
 
Done in gcmcomp @ 7799. Found that I need to shift Spencer earlier by one hour to match. Compare to MarsCirG:24, which has same number of time steps. Spencer always warmer; MAR= 3.2; see Fig. \ref{Spenc}.  A quick look at the code did not see that any roughness parameters are involved.

\begin{figure}[!ht] \igq{Spenc}
\caption[Spencer model]{Spencer model run with inertia 200 SI and 256 time-step per hour, plus signs, compared to KRC run with the same number of time-steps, line.
\label{Spenc} Spenc.png }
\end{figure} 
% how made: 


\appendix %===============================================================
\section{ERROR handling in v3.2.2}

If TDAY(1) detects potential instability (convergence too small), it prints message to IOERR and sets IRET=2, finishes calculations and returns.
\qi KRC finds IRD.NE.1, so calls TPRINT(2), writes error message to IOSP,
\qii (if disk open, calls TDISK(4) ) 
\qi quits.

TDISK writes each case place, so cannot omit a case; need to set some flag in
that case.  Because t5x values stored in FFF, which is not re-zeroed with each
file, it could contain values that look reasonable for a prior file in same KRC
run. Thus, the safe thing to do would be to write the first season with null
values for some flag.

Need to force J5=JDISK, this will set JOUT=0 [TDISK line 223] 
Can set NDJ4 all to zero as a flag for null season 
 NDJ4(MAXN4E) is in latcom, MAXN4E =38
Desire it to write a blank case to disk and go to next case!

If blowup occurs in TDAY(2), sets IRET=2, prints messages to IOSP, Calls TPRINT(7), TDISK (2,I) [if disk open), TPRINT(2), and returns.
\qi TLATS then sets IRL=2 and returns 
\qi TSEAS will not do another season, and returns a 2
\qi KRC finds IRS not 1, write error messages to IOPM and IOSP and proceeds to next case

\subsection{TDISK and BINF5} %-------------
\vspace{-3.mm} 
\begin{verbatim}


Monitor::
                                                                            
 Case 18  DTIME: total, user, system=    3.0485    3.0485    0.0000
 ======================== RUN-CASE     1    19 ========================
     0.370 seconds at start of season   80 of  640
     0.745 seconds at start of season  160 of  640
     1.121 seconds at start of season  240 of  640
     1.497 seconds at start of season  320 of  640
     1.872 seconds at start of season  400 of  640
     2.248 seconds at start of season  480 of  640
     2.624 seconds at start of season  560 of  640
     3.000 seconds at start of season  640 of  640
     3.006 seconds at end of season  640 of  640
 IG=           0   RBUF=0/ ================================= end of job                                 
 Case 19  DTIME: total, user, system=    3.0055    3.0055    0.0000
 BINF5: ARCH S= litend <           2
 BINF5 2013jan02 called with ID=            5          48           7           3         644          19           0           5          25           0
 BINF5 error: W IRET, IERR=          -4          -5
 ID=           5          48           7           3         644          19           0           5          25           0
      END KRC   Total time [s]=   53.809822 

---- looking inside  binf5.F  and  /home/hkieffer/src/cnew/cisis/primio.c
 -4 is error from  PIO_WT; -5 is  
    (void) sprintf(errbuf,"Error writing %ld bytes at byte %ld to file %s", 
                  (long) nbytes, (long) ibyte, fb->filnam);
---   

 CALL PIO_CL (FID, 1, IECL) ! close and delete the binary file

----------------------------------------------------------------------------------

  From Print file 

 IDX= 4  JJJ=   5  48   7   3 644   0   0   5  25   0
 MMM=          48         336        1008      645120           0           0
 KOMMON,KASE=    10000000      649152
 RASE,MASE,MTOT=   15.404713              15     9737280
     2.683 seconds at end of season  640 of  640

BINF5 W IRET, IERR=          -4          -5
#####                            
KRCv3.2.3    RUN-CASE  1-18   2016 Jan 10 07:32:03  PAGE= 55
--------- TYPE LOC VALUE -------- Parameter changes
 Changed>>   2   1   20.00     NLAY  N1    
 Case 18  DTIME: total, user, system=    3.0485    3.0485    0.0000
#####
    20    1.2375    0.0402    8.2024    0.2664   458.380   5.850
 Bottom                      8.8212    0.2865
 Lower layer of time doubling:   5  7 10 12 15 17 20
     3.006 seconds at end of season  640 of  640

     END OF DATA ON INPUT UNIT
 Case 19  DTIME: total, user, system=    3.0055    3.0055    0.0000
 JJJ=           5          48           7           3         644          19           0           5          25           0
 Wrote bin5 file: type and iret=           52          -4
   File name=/work1/krc/test/MarsD.t52                                                       
      END KRC   Total time [s]=   53.809822 
\end{verbatim} 
BINF5 in v 3.2.3,\nf{binf5.2015mar11} deletes file after a write error!  Modified 2016jan10 to ask if file should be deleted or only closed.


\section{Plot control in tttmod}
\np{kv3} reads the .t52 file and passes arrays to \np{tttmod}.

@640 Based on pari[13], calc diurnal average \nv{tave} for: surface, one layer, or bottom.
\\ pari[14] sets the reference case, negative means each case, 
\\ Pari[15] sets reference year. Form the diurnal average relative to the reference case, \nv{trel}
\\ pari[7:8] set the range of cases to be retained  in  \nv{trek} and \nv{trf}

Beginning 2016jan20, begin to convert all \np{ttmod} layer indices for input,
plots and print to be compatible with KRC, which is the 1-based number including
the virtual layer. Thus in IDL code referring to the ddd array, which starts
with the top physical layer, the values are 2 smaller.  In the 3-column
\np{ttmod} plot legends, the case is 0-based and the number of layers is the KRC
NLAY; these values are stored in \nv{nlac} in \np{ttmod} and the highest valid
IDL layer index is 2 smaller.

@64 Clot Trel , and abs(trel) as log, for each latitude 

@643 
\vspace{-3.mm} 
\begin{verbatim}
640: get the diurnal Tave to be used 
64: CLOT Secular relative temps for each lats  REQ 640
641: CLOT tref REQ 64
642: CLOT all latitudes at once REQ 64
643: CLOT surf and bot end of year for all lats  REQ 64
644: Many CLOTs one model
645: MAR for the last year
646: Secular layers for 1 lat and case
647: Layer variation for 1 lat and case REQ 646
648: Bottom temp trends  REQ 783
649: Bottom temp trends all lats at once  REQ 648 INCOMPLETE
65: S model
652: S forecast for a run REQ 65 644
\end{verbatim}


Using TTTMOD @113,123, which leads to @64 to show the diurnal average temperature
through each year relative to that of the last year.  See that there can be
noise at the 0.005K level in Ts, especially for the deepest case;
Fig. \ref{tm64bD0}.

\section{IDL KRC-related Programs 2016jan06}
\vspace{-3.mm} 
\begin{verbatim}
  Made by cd to -/idl/krc  
fgrep -in ';_Titl' *.pro > q  Get all title lines
fgrep ':1:' q             Look for those without an executable before them
EXAMT52   Read KRC style 52 files to test low I capability
GCMCOMP   Read KRC type 52 files Compare to Haberle, Mellon, Vasa., Lewis
KRCAMOEBA interface to KRC Thermal model: Amoeba convergence to data
KRCGA     interpolate KRC global average temperature to make global map
KRCVERTEST  Compare runs of different versions of KRC
KRCV      Test output for KRC vector insolation geometry
KV3       Check consistency of KRC within and between versions
MAPREBIN  Put Albedo, inertia, elevation maps to uniform grid
MLS       details  INCOMPLETE
PORBTEST  Various checks of KRC PORB regular and test output
QKRCHEMI  Test hemispherical integration for remote viewer
QVH       Investigate Vicki Hamilton 2006 2013 differences

Major analysis subroutines
TTTMOD    Special operation of krc type 52 arrays
\end{verbatim} 
\section{Binary file type 52 guide}
Sample of kv3@188. all but krccom are available in TTTMOD
\vspace{-3.mm} 
\begin{verbatim}
TTT             DOUBLE    = Array[48, 5, 3, 640, 15] 
(hour,item,latitude,season,case)
itemt =  Tsurf Tplan Tatm DownVIS DownIR
DDD             DOUBLE    = Array[45, 2, 3, 640, 15]
(layer,item,latitude,season,case)
itemd =  Tmin Tmax
GGG             DOUBLE    = Array[6, 3, 640, 15]
(item,latitude,season,case)
itemg =  NDJ4 DTM4 TTA4 FROST4 AFRO4 HEATMM
UUU             DOUBLE    = Array[3, 2, 15]
(nlat,item,case)
itemu =  Lat. elev
VVV             DOUBLE    = Array[640, 5, 15]
(season,item,case)
itemv =  DJU5 SUBS PZREF TAUD SUMF
KRCCOM is in kcom:
** Structure <d1f268>, 7 tags, length=1704, data length=1704, refs=1:
   FD              DOUBLE    Array[96]
   ALAT            DOUBLE    Array[37]
   ELEV            DOUBLE    Array[37]
   ID              LONG      Array[40]
   LD              LONG      Array[20]
   TIT             BYTE      Array[84]
   DAYTIM          BYTE      Array[20]
\end{verbatim} 

\end{document} %==========================================
% ===================== stuff beyond here ignored =============================

\begin{figure}[!ht] \igq{}
\caption[]{
\label{}  }
\end{figure} 
% how made: 

\begin{table} \caption[]{} \label{}
\begin{verbatim}
 i  RLAY   FLAY    CVG NLAY  Ntime    Deep  Sconv   secs    MAR   Tdel
 0 1.062  0.024   8.00   50  98304    6.99   9.01  14.24  0.011  -0.02
 1 1.062  0.024   8.00   50  49152    6.99   4.51   8.56  0.023  -0.04
 2 1.062  0.024   8.00   50 196608    6.99  18.02  24.03  0.003  -0.00
 3 1.062  0.024   8.00   50 393216    6.99  36.04  44.22  0.000   0.00
 4 1.100  0.025   8.00   37  49152    7.48   4.89   7.00  0.014  -0.04
 5 1.100  0.025   8.00   40  49152   10.04   4.89   7.00  0.014  -0.04
\end{verbatim}
\vspace{-3.0mm}
\hrulefill \end{table} 

\vspace{-3.mm} 
\begin{verbatim}

last case of E

k5,melt,Reset T change=       1      0.29576438      -12.016257
k5,melt,Reset T change=       3    0.0050506727     -0.23743644
k5,melt,Reset T change=       5   8.5855464e-05   -0.0040349792
k5,melt,Reset T change=       7   1.4593609e-06  -6.8585752e-05
k5,melt,Reset T change=       9   2.4806042e-08  -1.1658114e-06
k5,melt,Reset T change=      11   4.2138026e-10  -1.9816071e-08
Num seasons and elapsed time1=       14       46.208665
plot,ttm[37,0:12]-ttm[37,13],/ylog shows decrease factors of 2 and 40 alternating.

      nlay   n/H H/sol  mset    n5  flay  rlay       ggt  Lset     etime   depth
   0    32    96    48     2    20  0.12  1.20  1.00e-05     2    8.9784   204.5
   1    13    96    48     2    20  0.12  1.20  1.00e-05     2    2.8186     5.8
   2    19    96    48     2    20  0.12  1.10  1.00e-05     2    2.8818     6.1
   3    27    96    48     2    20  0.12  1.05  1.00e-05     2    3.6661     6.6
   4    39    96    48     2    20  0.12  1.02  1.00e-05     2    3.8613     7.0
   5    46    96    48     2    20  0.12  1.01  1.00e-05     2    3.9246     7.0
   6    58    96    48     2    20  0.12  1.00  1.00e-05     2    4.0729     7.0
   7    14    96    48     2    20  0.10  1.20  1.00e-05     2    2.7791     5.9
   8    21    96    48     2    20  0.10  1.10  1.00e-05     2    3.6062     6.4
   9    30    96    48     2    20  0.10  1.05  1.00e-05     2    3.6498     6.6
  10    18    96    48     2    20  0.05  1.20  1.00e-05     2    3.4594     6.4
  11    28    96    48     2    20  0.05  1.10  1.00e-05     2    3.5796     6.7
  12    42    96    48     2    20  0.05  1.05  1.00e-05     2    3.7956     6.8
  13    67    96    48     2    20  0.05  1.02  1.00e-05     2    4.0994     6.9
  14   140    96    48     2    20  0.05  1.00  1.00e-05     2    4.9998     7.0
  15    34    96    48     2    20  0.05  1.10  1.00e-05     2    5.8276    12.3
  16    38    96    48     2    20  0.05  1.10  1.00e-05     2    7.4432    18.2
  17    38   192    48     2    20  0.05  1.10  1.00e-05     2   14.9342    18.2
  18    38   384    48     2    20  0.05  1.10  1.00e-05     2   29.8689    18.2
  19    38   384    48     2    20  0.05  1.10  1.00e-08     2   46.2087    18.2
Tdel range:     -0.18112175      0.17926440
-----------------------------

IDL> pm=reverse(asol[384:*])
IDL> qq=asol[0:383]-pm
IDL> plot,qq
asol is symmetric to 5.e-13 w/m^2
asol point are downVIs at the center of each of the ntim intervals in a sol
KRC downvis:
 tdisk: filing one season:  DO J4=1,N4           ! do each latitude
             CALL R2R (DOWNVIS (1,J4),FFF(I+3*MM1),MM1*2) ! item 5
tday uses ASOL(JJ) , which is in DAYCOM
 in tlats, the angle is  RANG=2.0D0*PIVAL/N2  ,   ANGLE=(DFLOAT(JJ)-0.5D0)*RANG 
with N2 intervals per sol. So KRC is at the center of those intervals
KRC run with N2=384, so must do the same for KRCsimple

Range of KRC-KRCSim DownVIs  -1.2221412e-06   3.1671727e-06 noon=       589.20414

 KRC run with 13 cases. 2nd has RLAY=1 but depth table skips 17:21,
 stops after 23 and 
has layer thick increase:
   15    0.1800    0.0058    2.4300    0.0779   129.184   2.970
   16    0.1800    0.0058    2.6100    0.0836   138.411   2.970
   22    0.5015    0.0161    6.5002    0.2083   346.076   2.882
   23    0.5265    0.0169    7.0142    0.2247   373.069   3.177
0Bottom layers for time doubling:      2    3    4    5   11   18   23

gcmcomp  11 252 22

